{"/facturotas.docs/api/":{"data":{"":"","introducción#Introducción":"Introducción Nuestra API de timbrado se especializa en la emisión e integración de Comprobantes Fiscales Digitales por Internet (CFDI). Sus principales cualidades son:\nCualidades Técnicas Seguridad y Escalabilidad: Utiliza infraestructura de Amazon Web Services (AWS) con servicios EC2 para alta seguridad y escalabilidad, garantizando un 99.5% de disponibilidad y un Plan de Recuperación de Desastres (DRP). Los PACs están autorizados por el SAT y cumplen con ISO 27001, con comunicaciones SSL seguras. Actualizaciones: Mantenimiento constante para tecnologías fiscales, incluyendo CFDI 4.0, Complemento Carta Porte 2.0, Nuevo Esquema Cancelación 2.0, Complemento de Pagos 2.0 y Retenciones 2.0, disponibles desde enero de 2022. Métodos de Integración: Soporta timbrado vía XML, JSON y TXT. También ofrece un Conector Ejecutable en Java para timbrar y cancelar CFDI. Librerías: Proporciona bibliotecas gratuitas con ejemplos en PHP, Java, .Net, COM (VB6, Delphi, FoxPro) para integrar los servicios XML, JSON y TXT. Rendimiento: Capacidad mensual de hasta 130,000,000 de CFDI’s con un tiempo máximo de respuesta de 0.6 segundos. Respaldo y Generación: Respaldo de CFDI’s por al menos 5 años y capacidad de generación de PDF. Integraciones: Soporta métodos SOAP y REST. Cualidades No Técnicas Beneficios al Cliente: Timbres sin vigencia, actualizaciones y cancelaciones gratuitas, y soporte técnico especializado sin costo adicional. Soporte Técnico: Atención personalizada por ingenieros especialistas, con soporte por niveles (básico, técnico, desarrollo, VIP) a través de Skype, e-mail, videollamada, conexión remota y WhatsApp. Herramientas de Gestión: Panel administrativo Multi-RFC sin costo para controlar operaciones, consultar CFDI’s, timbres y cancelaciones, y gestionar subcuentas. Ambiente de Pruebas: Disponibilidad de un ambiente de pruebas con soporte. Asesoría: Asesoría profesional para el proceso de integración. Validador de XML: Servicio adicional que valida CFDI timbrados, confirmando su registro en el SAT y revisando parámetros como redacción y sintaxis. Bóveda Web Service: Descarga automática de CFDI desde el portal del SAT, con respaldo seguro en múltiples centros de datos. Permite cargar FIEL, configurar descargas y generar reportes. Timbrado MultiPAC: Balanceador de carga que redirige el timbrado entre PACs para evitar intermitencias, de forma transparente para el cliente. Todas las solicitudes son seguras vía HTTPS. Endpoints"},"title":"_index"},"/facturotas.docs/api/timbrado/":{"data":{"":"Esta sección detalla la operación del servicio de timbrado, permitiendo procesar y obtener el XML timbrado de un Comprobante Fiscal Digital (CFDI).\nTimbrado TimbradoTFD Timbrado JSON Timbrado JSON + PDF "},"title":"_index"},"/facturotas.docs/api/timbrado/timbrado/":{"data":{"endpoints-timbrado#Endpoints Timbrado":"Endpoints TimbradoEsta sección detalla la operación del servicio de timbrado, permitiendo procesar y obtener el XML timbrado de un Comprobante Fiscal Digital (CFDI).","timbrar#timbrar":"Descripción de la Operación Esta operación permite timbrar un (Comprobante Fiscal Digital por Internet) CFDI en sus versiones 3.3 o 4.0 y retornar el XML timbrado completo del comprobante fiscal junto con su folio fiscal UUID y sello digital por el SAT.\nParámetros de Entrada (Input) Parámetro Tipo de Dato Descripción apikey string Credencial de acceso al servicio (Solicita aquí). xmlCFDI string Contenido del documento XML del CFDI v3.3 o v4.0. Parámetros de Salida (Output) - RespuestaTimbrado Atributo Tipo de Dato Descripción code string Código de respuesta de la operación. message string Mensaje detallado de la respuesta. data string XML del CFDI timbrado en caso de éxito. Ejemplo de Código A continuación se presenta un ejemplo de cómo construir la solicitud y procesar la respuesta utilizando el servicio Web.\nSolicitud (Request) C#JavaPythonPHP Herramienta svcutil Descarga e instala la herramienta svcutil\nEjecuta el comando siguiente (DESARROLLO)\nsvcutil.exe https://dev.facturaloplus.com/ws/servicio.do?wsdl /out:ServicioTimbradoClient.cs /config:app.config Esto genera dos archivos: ServicioTimbradoClient.cs y la configuración en app.config\nImplementación /// Agregar los parámetros necesarios /// \u003csummary\u003e /// Genera un XML de ejemplo para un CFDI 4.0. /// En una aplicación real, este XML se construiría dinámicamente. /// \u003c/summary\u003e /// \u003creturns\u003eUn string con el contenido del CFDI.\u003c/returns\u003e private static string TimbrarCfdi() =\u003e \"\"\" \u003c?xml version=\"1.0\" encoding=\"UTF-8\"?\u003e \u003ccfdi:Comprobante xmlns:cfdi=\"http://www.sat.gob.mx/cfd/4\" xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\" xsi:schemaLocation=\"http://www.sat.gob.mx/cfd/4 cfdv40.xsd\" Version=\"4.0\" Serie=\"F\" Folio=\"123\" Fecha=\"2025-07-02T12:00:00\" SubTotal=\"100.00\" TipoCambio=\"1.0\" Serie=\"A\" Moneda=\"MXN\" Descuento=\"0.00\" Total=\"116.00\" TipoDeComprobante=\"I\" Exportacion=\"01\" MetodoPago=\"PUE\" CondicionesDePago=\"CONDICIONES\" FormaPago=\"01\" Confirmacion=\"A1234\" NoCertificado=\"30001000000300023708\" Certificado=\"\" Sello=\"\" LugarExpedicion=\"64000\"\u003e \u003ccfdi:InformacionGlobal Meses=\"18\" Año=\"2025\" Periodicidad=\"05\" /\u003e \u003ccfdi:CfdiRelacionados TipoRelacion=\"09\"\u003e \u003ccfdi:CfdiRelacionado UUID=\"ED1752FE-E865-4FF2-BFE1-0F552E770DC9\" /\u003e \u003c/cfdi:CfdiRelacionados\u003e \u003ccfdi:Emisor FacAtrAdquirente=\"0123456789\" Rfc=\"ABC010101XYZ\" Nombre=\"Empresa Ejemplo\" RegimenFiscal=\"601\"/\u003e \u003ccfdi:Receptor Rfc=\"XAXX010101000\" Nombre=\"Publico en General\" DomicilioFiscalReceptor=\"64000\" RegimenFiscalReceptor=\"616\" ResidenciaFiscal=\"MEX\" UsoCFDI=\"G03\"/\u003e \u003ccfdi:Conceptos\u003e \u003ccfdi:Concepto ObjetoImp=\"01\" ClaveProdServ=\"01010101\" ClaveUnidad=\"C81\" NoIdentificacion=\"00001\" Cantidad=\"1.5\" Unidad=\"TONELADA\" Descripcion=\"ACERO\" ValorUnitario=\"1500000\" Importe=\"2250000\"\u003e \u003ccfdi:Impuestos\u003e \u003ccfdi:Traslados\u003e \u003ccfdi:Traslado Base=\"100.00\" Impuesto=\"002\" TipoFactor=\"Tasa\" TasaOCuota=\"0.160000\" Importe=\"16.00\"/\u003e \u003c/cfdi:Traslados\u003e \u003ccfdi:Retenciones\u003e \u003ccfdi:Retencion Base=\"2250000\" Impuesto=\"001\" TipoFactor=\"Tasa\" TasaOCuota=\"0.300000\" Importe=\"247500\"/\u003e \u003c/cfdi:Retenciones\u003e \u003c/cfdi:Impuestos\u003e \u003ccfdi:CuentaPredial Numero=\"51888\"/\u003e \u003c/cfdi:Concepto\u003e \u003c/cfdi:Conceptos\u003e \u003ccfdi:Impuestos TotalImpuestosRetenidos=\"247500\" TotalImpuestosTrasladados=\"360000\"\u003e \u003ccfdi:Retenciones\u003e \u003ccfdi:Retencion Impuesto=\"001\" Importe=\"247000\"/\u003e \u003ccfdi:Retencion Impuesto=\"003\" Importe=\"500\"/\u003e \u003c/cfdi:Retenciones\u003e \u003ccfdi:Traslados\u003e \u003ccfdi:Traslado Base=\"1.00\" Impuesto=\"002\" TipoFactor=\"Tasa\" TasaOCuota=\"1.600000\" Importe=\"360000\"/\u003e \u003c/cfdi:Traslados\u003e \u003c/cfdi:Impuestos\u003e \u003ccfdi:Complemento\u003e\u003c/cfdi:Complemento\u003e \u003c/cfdi:Comprobante\u003e \"\"\"; /// \u003csummary\u003e /// Invoca al servicio web para timbrar un CFDI de forma asíncrona. /// \u003c/summary\u003e /// \u003cparam name=\"apiKey\"\u003eLa credencial de acceso al servicio.\u003c/param\u003e /// \u003cparam name=\"xmlCfdi\"\u003eEl contenido del CFDI a timbrar.\u003c/param\u003e /// \u003creturns\u003eUn objeto RespuestaTimbrado con el resultado de la operación.\u003c/returns\u003e public async Task\u003cRespuestaTimbrado\u003e TimbrarAsync(string apiKey, string xmlCfdi) { using var client = new ServicioTimbradoWSPortTypeClient(\"ServicioTimbradoWSPort\"); try { var response = await client.timbrarAsync(apiKey, xmlCfdi); return new RespuestaTimbrado { Code = response.code, Message = response.message, Data = response.data }; } catch (FaultException\u003cRespuestaTimbrado\u003e ex) { _logger.LogError(ex, \"Error SOAP: {Code} - {Message}\", ex.Detail.code, ex.Detail.message); throw; } catch (CommunicationException ex) { _logger.LogError(ex, \"Error de comunicación con el servicio\"); throw; } catch (TimeoutException ex) { _logger.LogError(ex, \"Timeout en la comunicación\"); throw; } } /// \u003csummary\u003e /// Define la estructura del objeto de respuesta para mayor claridad. /// \u003c/summary\u003e public class RespuestaTimbrado { public string? Code { get; set; } public string? Message { get; set; } public string? Data { get; set; } } // Ejemplo de uso de TimbrarAsync public async Task EjemploUsoTimbrarAsync() { string apiKey = \"TU_API_KEY_AQUI\"; string xmlCfdi = TimbrarCfdi(); try { var resultado = await TimbrarAsync(apiKey, xmlCfdi); if (resultado.Code == \"200\") { Console.WriteLine(\"¡Timbrado Exitoso!\"); Console.WriteLine(\"Mensaje: \" + resultado.Message); Console.WriteLine(\"--- XML Timbrado ---\"); Console.WriteLine(resultado.Data); } else { Console.WriteLine(\"Error durante el timbrado:\"); Console.WriteLine(\"Código: \" + resultado.Code); Console.WriteLine(\"Mensaje: \" + resultado.Message); } } catch (Exception ex) { Console.WriteLine(\"Ocurrió una excepción: \" + ex.Message); } } Herramienta wsimport Java incluye la herramienta wsimport en el JDK para generar las clases cliente a partir de un WSDL.\nEjecuta el siguiente comando en tu terminal para el ambiente de DESARROLLO:\nwsimport -keep -p com.facturaloplus.cliente https://dev.facturaloplus.com/ws/servicio.do?wsdl -keep: Conserva los archivos fuente .java generados.\n-p: Especifica el paquete (package) donde se guardarán las clases.\nImplementación // --- Archivo: RespuestaTimbrado.java --- package com.facturaloplus.cliente; // POJO (Plain Old Java Object) para encapsular la respuesta. public class RespuestaTimbrado { private String code; private String message; private String data; // Getters y Setters public String getCode() { return code; } public void setCode(String code) { this.code = code; } public String getMessage() { return message; } public void setMessage(String message) { this.message = message; } public String getData() { return data; } public void setData(String data) { this.data = data; } } // --- Archivo: TimbradoService.java --- package com.facturaloplus.cliente; import javax.xml.ws.Service; import javax.xml.ws.WebServiceException; import javax.xml.ws.soap.SOAPFaultException; import java.time.LocalDateTime; import java.time.format.DateTimeFormatter; import java.util.concurrent.CompletableFuture; import java.util.concurrent.ExecutorService; import java.util.concurrent.Executors; import java.util.logging.Level; import java.util.logging.Logger; public class TimbradoService { private static final Logger logger = Logger.getLogger(TimbradoService.class.getName()); // Se recomienda un ExecutorService para manejar los hilos de las tareas asíncronas. private final ExecutorService executor = Executors.newFixedThreadPool(5); public String generarXmlCfdiEjemplo() { // Usar la fecha y hora actual en formato UTC, requerido por el SAT. String fechaActual = LocalDateTime.now().format(DateTimeFormatter.ofPattern(\"yyyy-MM-dd'T'HH:mm:ss\")); // Uso de Text Blocks (Java 15+) para el XML. // Nota: Se agregó ObjetoImp=\"02\" en el concepto, requerido en CFDI 4.0. return \"\"\" \u003c?xml version=\"1.0\" encoding=\"UTF-8\"?\u003e \u003ccfdi:Comprobante xmlns:cfdi=\"http://www.sat.gob.mx/cfd/4\" xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\" xsi:schemaLocation=\"http://www.sat.gob.mx/cfd/4 cfdv40.xsd\" Version=\"4.0\" Serie=\"F\" Folio=\"123\" Fecha=\"%s\" SubTotal=\"100.00\" TipoCambio=\"1.0\" Serie=\"A\" Moneda=\"MXN\" Descuento=\"0.00\" Total=\"116.00\" TipoDeComprobante=\"I\" Exportacion=\"01\" MetodoPago=\"PUE\" CondicionesDePago=\"CONDICIONES\" FormaPago=\"01\" Confirmacion=\"A1234\" NoCertificado=\"30001000000300023708\" Certificado=\"\" Sello=\"\" LugarExpedicion=\"64000\"\u003e \u003ccfdi:InformacionGlobal Meses=\"18\" Año=\"2025\" Periodicidad=\"05\" /\u003e \u003ccfdi:CfdiRelacionados TipoRelacion=\"09\"\u003e \u003ccfdi:CfdiRelacionado UUID=\"ED1752FE-E865-4FF2-BFE1-0F552E770DC9\" /\u003e \u003c/cfdi:CfdiRelacionados\u003e \u003ccfdi:Emisor FacAtrAdquirente=\"0123456789\" Rfc=\"ABC010101XYZ\" Nombre=\"Empresa Ejemplo\" RegimenFiscal=\"601\"/\u003e \u003ccfdi:Receptor Rfc=\"XAXX010101000\" Nombre=\"Publico en General\" DomicilioFiscalReceptor=\"64000\" RegimenFiscalReceptor=\"616\" ResidenciaFiscal=\"MEX\" UsoCFDI=\"G03\"/\u003e \u003ccfdi:Conceptos\u003e \u003ccfdi:Concepto ObjetoImp=\"01\" ClaveProdServ=\"01010101\" ClaveUnidad=\"C81\" NoIdentificacion=\"00001\" Cantidad=\"1.5\" Unidad=\"TONELADA\" Descripcion=\"ACERO\" ValorUnitario=\"1500000\" Importe=\"2250000\"\u003e \u003ccfdi:Impuestos\u003e \u003ccfdi:Traslados\u003e \u003ccfdi:Traslado Base=\"100.00\" Impuesto=\"002\" TipoFactor=\"Tasa\" TasaOCuota=\"0.160000\" Importe=\"16.00\"/\u003e \u003c/cfdi:Traslados\u003e \u003ccfdi:Retenciones\u003e \u003ccfdi:Retencion Base=\"2250000\" Impuesto=\"001\" TipoFactor=\"Tasa\" TasaOCuota=\"0.300000\" Importe=\"247500\"/\u003e \u003c/cfdi:Retenciones\u003e \u003c/cfdi:Impuestos\u003e \u003ccfdi:CuentaPredial Numero=\"51888\"/\u003e \u003c/cfdi:Concepto\u003e \u003c/cfdi:Conceptos\u003e \u003ccfdi:Impuestos TotalImpuestosRetenidos=\"247500\" TotalImpuestosTrasladados=\"360000\"\u003e \u003ccfdi:Retenciones\u003e \u003ccfdi:Retencion Impuesto=\"001\" Importe=\"247000\"/\u003e \u003ccfdi:Retencion Impuesto=\"003\" Importe=\"500\"/\u003e \u003c/cfdi:Retenciones\u003e \u003ccfdi:Traslados\u003e \u003ccfdi:Traslado Base=\"1.00\" Impuesto=\"002\" TipoFactor=\"Tasa\" TasaOCuota=\"1.600000\" Importe=\"360000\"/\u003e \u003c/cfdi:Traslados\u003e \u003c/cfdi:Impuestos\u003e \u003ccfdi:Complemento\u003e\u003c/cfdi:Complemento\u003e \u003c/cfdi:Comprobante\u003e \"\"\".formatted(fechaActual); } public CompletableFuture\u003cRespuestaTimbrado\u003e timbrarAsync(String apiKey, String xmlCfdi) { return CompletableFuture.supplyAsync(() -\u003e { try { // Las clases ServicioTimbradoWS y ServicioTimbradoWSPortType son generadas por wsimport. ServicioTimbradoWS service = new ServicioTimbradoWS(); ServicioTimbradoWSPortType port = service.getServicioTimbradoWSPort(); logger.info(\"Iniciando timbrado para CFDI.\"); Respuesta response = port.timbrar(apiKey, xmlCfdi); // 'Respuesta' es la clase generada por wsimport. RespuestaTimbrado resultado = new RespuestaTimbrado(); resultado.setCode(response.getCode()); resultado.setMessage(response.getMessage()); resultado.setData(response.getData()); return resultado; } catch (SOAPFaultException ex) { logger.log(Level.SEVERE, \"Error SOAP (SOAPFaultException): \" + ex.getFault().getFaultString(), ex); throw new RuntimeException(\"Error del servicio: \" + ex.getFault().getFaultString(), ex); } catch (WebServiceException ex) { logger.log(Level.SEVERE, \"Error de comunicación con el servicio de timbrado.\", ex); throw new RuntimeException(\"Error de comunicación.\", ex); } }, executor); } public void shutdown() { executor.shutdown(); } } // --- Archivo: Main.java (Ejemplo de uso) --- package com.facturaloplus.cliente; import java.util.concurrent.CompletableFuture; public class Main { public static void main(String[] args) { TimbradoService timbradoService = new TimbradoService(); // El API Key debe obtenerse de una fuente segura, no estar en el código. String miApiKey = \"TU_API_KEY_AQUI\"; String xmlParaTimbrar = timbradoService.generarXmlCfdiEjemplo(); System.out.println(\"--- Intentando timbrar el siguiente CFDI: ---\"); System.out.println(xmlParaTimbrar); System.out.println(\"------------------------------------------\"); CompletableFuture\u003cRespuestaTimbrado\u003e future = timbradoService.timbrarAsync(miApiKey, xmlParaTimbrar); future.whenComplete((resultado, ex) -\u003e { if (ex != null) { System.err.println(\"\\nOcurrió una excepción no controlada: \" + ex.getMessage()); } else { if (\"200\".equals(resultado.getCode())) { System.out.println(\"\\n¡Timbrado Exitoso!\"); System.out.println(\"Mensaje: \" + resultado.getMessage()); System.out.println(\"\\n--- XML Timbrado ---\"); System.out.println(resultado.getData()); } else { System.err.println(\"\\nError durante el timbrado:\"); System.err.println(\"Código: \" + resultado.getCode()); System.err.println(\"Mensaje: \" + resultado.getMessage()); } } // Es importante cerrar el ExecutorService cuando la aplicación termina. timbradoService.shutdown(); }); // Mantiene el programa principal vivo mientras se completa la tarea asíncrona. // En una aplicación real (ej. un servidor de aplicaciones), esto no sería necesario. future.join(); } } Herramienta Zeep Para interactuar con servicios SOAP en Python, la librería zeep es una excelente opción. Proporciona una interfaz limpia y moderna.\nInstala la librería usando pip:\npip install zeep Implementación El siguiente código muestra una implementación robusta utilizando zeep y asyncio para realizar llamadas asíncronas al servicio web.\n# --- Archivo: timbrado_service.py --- import asyncio import logging from datetime import datetime from zeep import Client from zeep.asyncio import AsyncClient from zeep.exceptions import Fault, TransportError from dataclasses import dataclass # Configuración básica de logging logging.basicConfig(level=logging.INFO, format='%(asctime)s - %(levelname)s - %(message)s') WSDL_URL_DESARROLLO = \"https://dev.facturaloplus.com/ws/servicio.do?wsdl\" @dataclass class RespuestaTimbrado: \"\"\"Clase de datos para encapsular la respuesta del servicio.\"\"\" code: str = None message: str = None data: str = None class TimbradoService: \"\"\"Clase que encapsula la lógica para interactuar con el servicio de timbrado.\"\"\" def __init__(self, wsdl_url: str): self.wsdl_url = wsdl_url # El cliente asíncrono se crea al momento de usarlo self.async_client = AsyncClient(self.wsdl_url) def generar_xml_cfdi_ejemplo(self) -\u003e str: \"\"\" Genera un XML de ejemplo para un CFDI 4.0. En una aplicación real, este XML se construiría dinámicamente. \"\"\" # Usar la fecha y hora actual en formato UTC, requerido por el SAT. fecha_actual = datetime.utcnow().strftime('%Y-%m-%dT%H:%M:%S') # Uso de f-strings para formatear el XML. # Nota: Se agregó ObjetoImp=\"02\" en el concepto, requerido en CFDI 4.0. return f\"\"\" \u003c?xml version=\"1.0\" encoding=\"UTF-8\"?\u003e \u003ccfdi:Comprobante xmlns:cfdi=\"http://www.sat.gob.mx/cfd/4\" xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\" xsi:schemaLocation=\"http://www.sat.gob.mx/cfd/4 cfdv40.xsd\" Version=\"4.0\" Serie=\"F\" Folio=\"123\" Fecha=\"{fecha_actual}\" SubTotal=\"100.00\" TipoCambio=\"1.0\" Serie=\"A\" Moneda=\"MXN\" Descuento=\"0.00\" Total=\"116.00\" TipoDeComprobante=\"I\" Exportacion=\"01\" MetodoPago=\"PUE\" CondicionesDePago=\"CONDICIONES\" FormaPago=\"01\" Confirmacion=\"A1234\" NoCertificado=\"30001000000300023708\" Certificado=\"\" Sello=\"\" LugarExpedicion=\"64000\"\u003e \u003ccfdi:InformacionGlobal Meses=\"18\" Año=\"2025\" Periodicidad=\"05\" /\u003e \u003ccfdi:CfdiRelacionados TipoRelacion=\"09\"\u003e \u003ccfdi:CfdiRelacionado UUID=\"ED1752FE-E865-4FF2-BFE1-0F552E770DC9\" /\u003e \u003c/cfdi:CfdiRelacionados\u003e \u003ccfdi:Emisor FacAtrAdquirente=\"0123456789\" Rfc=\"ABC010101XYZ\" Nombre=\"Empresa Ejemplo\" RegimenFiscal=\"601\"/\u003e \u003ccfdi:Receptor Rfc=\"XAXX010101000\" Nombre=\"Publico en General\" DomicilioFiscalReceptor=\"64000\" RegimenFiscalReceptor=\"616\" ResidenciaFiscal=\"MEX\" UsoCFDI=\"G03\"/\u003e \u003ccfdi:Conceptos\u003e \u003ccfdi:Concepto ObjetoImp=\"01\" ClaveProdServ=\"01010101\" ClaveUnidad=\"C81\" NoIdentificacion=\"00001\" Cantidad=\"1.5\" Unidad=\"TONELADA\" Descripcion=\"ACERO\" ValorUnitario=\"1500000\" Importe=\"2250000\"\u003e \u003ccfdi:Impuestos\u003e \u003ccfdi:Traslados\u003e \u003ccfdi:Traslado Base=\"100.00\" Impuesto=\"002\" TipoFactor=\"Tasa\" TasaOCuota=\"0.160000\" Importe=\"16.00\"/\u003e \u003c/cfdi:Traslados\u003e \u003ccfdi:Retenciones\u003e \u003ccfdi:Retencion Base=\"2250000\" Impuesto=\"001\" TipoFactor=\"Tasa\" TasaOCuota=\"0.300000\" Importe=\"247500\"/\u003e \u003c/cfdi:Retenciones\u003e \u003c/cfdi:Impuestos\u003e \u003ccfdi:CuentaPredial Numero=\"51888\"/\u003e \u003c/cfdi:Concepto\u003e \u003c/cfdi:Conceptos\u003e \u003ccfdi:Impuestos TotalImpuestosRetenidos=\"247500\" TotalImpuestosTrasladados=\"360000\"\u003e \u003ccfdi:Retenciones\u003e \u003ccfdi:Retencion Impuesto=\"001\" Importe=\"247000\"/\u003e \u003ccfdi:Retencion Impuesto=\"003\" Importe=\"500\"/\u003e \u003c/cfdi:Retenciones\u003e \u003ccfdi:Traslados\u003e \u003ccfdi:Traslado Base=\"1.00\" Impuesto=\"002\" TipoFactor=\"Tasa\" TasaOCuota=\"1.600000\" Importe=\"360000\"/\u003e \u003c/cfdi:Traslados\u003e \u003c/cfdi:Impuestos\u003e \u003ccfdi:Complemento\u003e\u003c/cfdi:Complemento\u003e \u003c/cfdi:Comprobante\u003e \"\"\" async def timbrar_async(self, api_key: str, xml_cfdi: str) -\u003e RespuestaTimbrado: \"\"\"Invoca al servicio web para timbrar un CFDI de forma asíncrona.\"\"\" try: logging.info(\"Iniciando timbrado para CFDI.\") # El nombre del servicio 'ServicioTimbradoWSPort' y la operación 'timbrar' # son definidos por el WSDL. response = await self.async_client.service.timbrar(apikey=api_key, xmlCFDI=xml_cfdi) # Zeep convierte la respuesta en un objeto similar a un diccionario. return RespuestaTimbrado( code=response.code, message=response.message, data=response.data ) except Fault as ex: logging.error(f\"Error SOAP (Fault): Code={ex.code}, Message={ex.message}\") raise ConnectionError(f\"Error del servicio: {ex.message}\") from ex except TransportError as ex: logging.error(f\"Error de comunicación con el servicio de timbrado: {ex}\") raise # --- Archivo: main.py (Ejemplo de uso) --- async def main(): \"\"\"Función principal para ejecutar el ejemplo.\"\"\" service = TimbradoService(WSDL_URL_DESARROLLO) # El API Key debe obtenerse de una fuente segura, no estar en el código. mi_api_key = \"TU_API_KEY_AQUI\" xml_para_timbrar = service.generar_xml_cfdi_ejemplo() print(\"--- Intentando timbrar el siguiente CFDI: ---\") print(xml_para_timbrar) print(\"------------------------------------------\") try: resultado = await service.timbrar_async(mi_api_key, xml_para_timbrar) if resultado.code == \"200\": print(\"\\033[92m\\n¡Timbrado Exitoso!\\033[0m\") # Color verde print(f\"Mensaje: {resultado.message}\") print(\"\\n--- XML Timbrado ---\") print(resultado.data) else: print(\"\\033[91m\\nError durante el timbrado:\\033[0m\") # Color rojo print(f\"Código: {resultado.code}\") print(f\"Mensaje: {resultado.message}\") except Exception as ex: print(f\"\\033[91m\\nOcurrió una excepción no controlada: {ex}\\033[0m\") if __name__ == \"__main__\": asyncio.run(main()) Herramienta SoapClient PHP tiene soporte nativo para SOAP a través de la extensión SOAP. Asegúrate de que la extensión php-soap esté habilitada en tu archivo php.ini.\nImplementación El siguiente código muestra una implementación orientada a objetos para consumir el servicio de timbrado.\n\u003c?php // --- Archivo: Timbrado.php --- // Habilitar la visualización de errores para depuración ini_set('display_errors', 1); error_reporting(E_ALL); /** * Clase DTO (Data Transfer Object) para encapsular la respuesta del servicio. */ class RespuestaTimbrado { public ?string $code = null; public ?string $message = null; public ?string $data = null; } /** * Clase que encapsula la lógica para interactuar con el servicio de timbrado. */ class TimbradoService { private string $wsdlUrl; public function __construct(string $wsdlUrl) { $this-\u003ewsdlUrl = $wsdlUrl; } /** * Genera un XML de ejemplo para un CFDI 4.0. */ public function generarXmlCfdiEjemplo(): string { // Usar la fecha y hora actual en formato UTC, requerido por el SAT. $fechaActual = gmdate('Y-m-d\\TH:i:s'); // Nota: Se agregó ObjetoImp=\"02\" en el concepto, requerido en CFDI 4.0. return \u003c\u003c\u003cXML \u003c?xml version=\"1.0\" encoding=\"UTF-8\"?\u003e \u003ccfdi:Comprobante xmlns:cfdi=\"http://www.sat.gob.mx/cfd/4\" xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\" xsi:schemaLocation=\"http://www.sat.gob.mx/cfd/4 cfdv40.xsd\" Version=\"4.0\" Serie=\"F\" Folio=\"123\" Fecha=\"{$fechaActual}\" SubTotal=\"100.00\" TipoCambio=\"1.0\" Serie=\"A\" Moneda=\"MXN\" Descuento=\"0.00\" Total=\"116.00\" TipoDeComprobante=\"I\" Exportacion=\"01\" MetodoPago=\"PUE\" CondicionesDePago=\"CONDICIONES\" FormaPago=\"01\" Confirmacion=\"A1234\" NoCertificado=\"30001000000300023708\" Certificado=\"\" Sello=\"\" LugarExpedicion=\"64000\"\u003e \u003ccfdi:InformacionGlobal Meses=\"18\" Año=\"2025\" Periodicidad=\"05\" /\u003e \u003ccfdi:CfdiRelacionados TipoRelacion=\"09\"\u003e \u003ccfdi:CfdiRelacionado UUID=\"ED1752FE-E865-4FF2-BFE1-0F552E770DC9\" /\u003e \u003c/cfdi:CfdiRelacionados\u003e \u003ccfdi:Emisor FacAtrAdquirente=\"0123456789\" Rfc=\"ABC010101XYZ\" Nombre=\"Empresa Ejemplo\" RegimenFiscal=\"601\"/\u003e \u003ccfdi:Receptor Rfc=\"XAXX010101000\" Nombre=\"Publico en General\" DomicilioFiscalReceptor=\"64000\" RegimenFiscalReceptor=\"616\" ResidenciaFiscal=\"MEX\" UsoCFDI=\"G03\"/\u003e \u003ccfdi:Conceptos\u003e \u003ccfdi:Concepto ObjetoImp=\"01\" ClaveProdServ=\"01010101\" ClaveUnidad=\"C81\" NoIdentificacion=\"00001\" Cantidad=\"1.5\" Unidad=\"TONELADA\" Descripcion=\"ACERO\" ValorUnitario=\"1500000\" Importe=\"2250000\"\u003e \u003ccfdi:Impuestos\u003e \u003ccfdi:Traslados\u003e \u003ccfdi:Traslado Base=\"100.00\" Impuesto=\"002\" TipoFactor=\"Tasa\" TasaOCuota=\"0.160000\" Importe=\"16.00\"/\u003e \u003c/cfdi:Traslados\u003e \u003ccfdi:Retenciones\u003e \u003ccfdi:Retencion Base=\"2250000\" Impuesto=\"001\" TipoFactor=\"Tasa\" TasaOCuota=\"0.300000\" Importe=\"247500\"/\u003e \u003c/cfdi:Retenciones\u003e \u003c/cfdi:Impuestos\u003e \u003ccfdi:CuentaPredial Numero=\"51888\"/\u003e \u003c/cfdi:Concepto\u003e \u003c/cfdi:Conceptos\u003e \u003ccfdi:Impuestos TotalImpuestosRetenidos=\"247500\" TotalImpuestosTrasladados=\"360000\"\u003e \u003ccfdi:Retenciones\u003e \u003ccfdi:Retencion Impuesto=\"001\" Importe=\"247000\"/\u003e \u003ccfdi:Retencion Impuesto=\"003\" Importe=\"500\"/\u003e \u003c/cfdi:Retenciones\u003e \u003ccfdi:Traslados\u003e \u003ccfdi:Traslado Base=\"1.00\" Impuesto=\"002\" TipoFactor=\"Tasa\" TasaOCuota=\"1.600000\" Importe=\"360000\"/\u003e \u003c/cfdi:Traslados\u003e \u003c/cfdi:Impuestos\u003e \u003ccfdi:Complemento\u003e\u003c/cfdi:Complemento\u003e \u003c/cfdi:Comprobante\u003e XML; } /** * Invoca al servicio web para timbrar un CFDI. */ public function timbrar(string $apiKey, string $xmlCfdi): RespuestaTimbrado { $respuesta = new RespuestaTimbrado(); try { // Opciones para el cliente SOAP. 'trace' es útil para depurar. $options = [ 'trace' =\u003e 1, 'exceptions' =\u003e true, // Lanza SoapFault en caso de error 'cache_wsdl' =\u003e WSDL_CACHE_NONE ]; // Crear el cliente SOAP $soapClient = new SoapClient($this-\u003ewsdlUrl, $options); // Los parámetros deben estar en un array asociativo $params = [ 'apikey' =\u003e $apiKey, 'xmlCFDI' =\u003e $xmlCfdi ]; // Llamar a la operación 'timbrar' del servicio $response = $soapClient-\u003etimbrar($params); $respuesta-\u003ecode = $response-\u003ereturn-\u003ecode ?? null; $respuesta-\u003emessage = $response-\u003ereturn-\u003emessage ?? null; $respuesta-\u003edata = $response-\u003ereturn-\u003edata ?? null; } catch (SoapFault $e) { // Capturar errores específicos de SOAP error_log(\"Error SOAP (SoapFault): \" . $e-\u003egetMessage()); $respuesta-\u003ecode = \"FAULT\"; $respuesta-\u003emessage = \"Error en la comunicación SOAP: \" . $e-\u003egetMessage(); } catch (Exception $e) { // Capturar otros errores error_log(\"Error general: \" . $e-\u003egetMessage()); $respuesta-\u003ecode = \"EXCEPTION\"; $respuesta-\u003emessage = \"Ocurrió una excepción: \" . $e-\u003egetMessage(); } return $respuesta; } } // --- Archivo: index.php (Ejemplo de uso) --- // Incluir la clase del servicio // require_once 'Timbrado.php'; $wsdlDesarrollo = \"https://dev.facturaloplus.com/ws/servicio.do?wsdl\"; $timbradoService = new TimbradoService($wsdlDesarrollo); // El API Key debe obtenerse de una fuente segura, como una variable de entorno. $miApiKey = getenv('TIMBRADO_API_KEY') ?: \"TU_API_KEY_AQUI\"; $xmlParaTimbrar = $timbradoService-\u003egenerarXmlCfdiEjemplo(); // Imprimir en formato de texto plano para una mejor visualización en consola o web header('Content-Type: text/plain; charset=utf-8'); echo \"--- Intentando timbrar el siguiente CFDI: ---\\n\"; echo $xmlParaTimbrar; echo \"\\n------------------------------------------\\n\\n\"; $resultado = $timbradoService-\u003etimbrar($miApiKey, $xmlParaTimbrar); if ($resultado-\u003ecode === '200') { echo \"¡Timbrado Exitoso!\\n\"; echo \"Mensaje: {$resultado-\u003emessage}\\n\"; echo \"\\n--- XML Timbrado ---\\n\"; echo $resultado-\u003edata; } else { echo \"Error durante el timbrado:\\n\"; echo \"Código: {$resultado-\u003ecode}\\n\"; echo \"Mensaje: {$resultado-\u003emessage}\\n\"; } ?\u003e Respuesta (Response) \u003c?xml version=\"1.0\" encoding=\"UTF-8\"?\u003e \u003cSOAP-ENV:Envelope SOAP-ENV:encodingStyle=\"http://schemas.xmlsoap.org/soap/encoding/\" xmlns:SOAP-ENV=\"http://schemas.xmlsoap.org/soap/envelope/\" xmlns:xsd=\"http://www.w3.org/2001/XMLSchema\" xmlns:xsi=\"http://www.w3.org/2001/XMLSchema- instance\" xmlns:SOAP-ENC=\"http://schemas.xmlsoap.org/soap/encoding/\" xmlns:tns=\"urn:ws_api\"\u003e \u003cSOAP-ENV:Body\u003e \u003cns1:timbrarResponse xmlns:ns1=\"urn:ws_api\"\u003e \u003creturn xsi:type=\"tns:RespuestaTimbrado\"\u003e \u003ccode xsi:type=\"xsd:string\"\u003eCÓDIGO\u003c/code\u003e \u003cmessage xsi:type=\"xsd:string\"\u003eMENSAJE\u003c/message\u003e \u003cdata xsi:type=\"xsd:string\"\u003e\u003c![CDATA[CFDI TIMBRADO]]\u003e\u003c/data\u003e \u003c/return\u003e \u003c/ns1:timbrarResponse\u003e \u003c/SOAP-ENV:Body\u003e \u003c/SOAP-ENV:Envelope\u003e Códigos de respuesta Los códigos de respuesta para el timbrado de CFDI son importantes para entender el resultado de la solicitud. A continuación se detallan los códigos más comunes que puedes recibir al realizar una solicitud de timbrado a través de la API.\rCódigo\rDescripción\r200\rSolicitud procesada con éxito\r300\rAPI KEY Inválida o inexistente\r301\rXML mal formado\r302\rEl sello del emisor no es válido\r303\rEl RFC del CSD del emisor no corresponde al RFC del Emisor\r304\rCSD del Emisor ha sido revobado\r305\rLa fecha de emisión no está dentro de la vigencia del CSD del Emisor\r306\rLa llave utilizada para sellar debe ser un CSD\r307\rEl CFDI contiene un timbre previo\r308\rEl CSD del emisor no ha sido firmado por uno de los Certificados de autoridad del SAT\r401\rEl rango de la fecha de generación no debe de ser mayor a 72 horas para la emisión del timbre\r402\rRFC del emisor no se encuentra en el régimen de contribuyentes (Lista de validación de régimen) LCO"},"title":"timbrado"},"/facturotas.docs/api/timbrado/timbradotfd/":{"data":{"#":"timbrarTFDDescripción de la Operación Esta operación permite timbrar un Comprobante Fiscal Digital por Internet (CFDI) en sus versiones 3.3 o 4.0 y, a diferencia de la operación timbrar, retorna únicamente el Timbre Fiscal Digital (TFD) como un XML independiente. Esto es útil cuando se necesita solo el TFD para procesos de validación o almacenamiento por separado.\nParámetros de Entrada (Input) Parámetro Tipo de Dato Descripción apikey string Credencial de acceso al servicio (Solicita aquí). xmlCFDI string Contenido del documento XML del CFDI v3.3 o v4.0 a timbrar. Parámetros de Salida (Output) - RespuestaTimbradoTFD Atributo Tipo de Dato Descripción code string Código de respuesta de la operación. message string Mensaje detallado de la respuesta. data string XML del Timbre Fiscal Digital (TFD) en caso de éxito. Ejemplo de Código A continuación se presenta un ejemplo de cómo construir la solicitud y procesar la respuesta utilizando el servicio Web.\nSolicitud (Request) C#JavaPythonPHP Herramienta svcutil Descarga e instala la herramienta svcutil\nEjecuta el comando siguiente (DESARROLLO)\nsvcutil.exe https://dev.facturaloplus.com/ws/servicio.do?wsdl /out:ServicioTimbradoClient.cs /config:app.config Esto genera dos archivos: ServicioTimbradoClient.cs y la configuración en app.config\nImplementación /// \u003csummary\u003e /// Genera un XML de ejemplo para un CFDI 4.0. /// En una aplicación real, este XML se construiría dinámicamente. /// \u003c/summary\u003e /// \u003creturns\u003eUn string con el contenido del CFDI.\u003c/returns\u003e private static string GenerarCfdiParaTimbrar() =\u003e \"\"\" \u003c?xml version=\"1.0\" encoding=\"UTF-8\"?\u003e \u003ccfdi:Comprobante xmlns:cfdi=\"http://www.sat.gob.mx/cfd/4\" xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\" xsi:schemaLocation=\"http://www.sat.gob.mx/cfd/4 cfdv40.xsd\" Version=\"4.0\" Serie=\"F\" Folio=\"123\" Fecha=\"2025-07-02T12:00:00\" SubTotal=\"100.00\" TipoCambio=\"1.0\" Serie=\"A\" Moneda=\"MXN\" Descuento=\"0.00\" Total=\"116.00\" TipoDeComprobante=\"I\" Exportacion=\"01\" MetodoPago=\"PUE\" CondicionesDePago=\"CONDICIONES\" FormaPago=\"01\" Confirmacion=\"A1234\" NoCertificado=\"30001000000300023708\" Certificado=\"\" Sello=\"\" LugarExpedicion=\"64000\"\u003e \u003ccfdi:InformacionGlobal Meses=\"18\" Año=\"2025\" Periodicidad=\"05\" /\u003e \u003ccfdi:CfdiRelacionados TipoRelacion=\"09\"\u003e \u003ccfdi:CfdiRelacionado UUID=\"ED1752FE-E865-4FF2-BFE1-0F552E770DC9\" /\u003e \u003c/cfdi:CfdiRelacionados\u003e \u003ccfdi:Emisor FacAtrAdquirente=\"0123456789\" Rfc=\"ABC010101XYZ\" Nombre=\"Empresa Ejemplo\" RegimenFiscal=\"601\"/\u003e \u003ccfdi:Receptor Rfc=\"XAXX010101000\" Nombre=\"Publico en General\" DomicilioFiscalReceptor=\"64000\" RegimenFiscalReceptor=\"616\" ResidenciaFiscal=\"MEX\" UsoCFDI=\"G03\"/\u003e \u003ccfdi:Conceptos\u003e \u003ccfdi:Concepto ObjetoImp=\"01\" ClaveProdServ=\"01010101\" ClaveUnidad=\"C81\" NoIdentificacion=\"00001\" Cantidad=\"1.5\" Unidad=\"TONELADA\" Descripcion=\"ACERO\" ValorUnitario=\"1500000\" Importe=\"2250000\"\u003e \u003ccfdi:Impuestos\u003e \u003ccfdi:Traslados\u003e \u003ccfdi:Traslado Base=\"100.00\" Impuesto=\"002\" TipoFactor=\"Tasa\" TasaOCuota=\"0.160000\" Importe=\"16.00\"/\u003e \u003c/cfdi:Traslados\u003e \u003ccfdi:Retenciones\u003e \u003ccfdi:Retencion Base=\"2250000\" Impuesto=\"001\" TipoFactor=\"Tasa\" TasaOCuota=\"0.300000\" Importe=\"247500\"/\u003e \u003c/cfdi:Retenciones\u003e \u003c/cfdi:Impuestos\u003e \u003ccfdi:CuentaPredial Numero=\"51888\"/\u003e \u003c/cfdi:Concepto\u003e \u003c/cfdi:Conceptos\u003e \u003ccfdi:Impuestos TotalImpuestosRetenidos=\"247500\" TotalImpuestosTrasladados=\"360000\"\u003e \u003ccfdi:Retenciones\u003e \u003ccfdi:Retencion Impuesto=\"001\" Importe=\"247000\"/\u003e \u003ccfdi:Retencion Impuesto=\"003\" Importe=\"500\"/\u003e \u003c/cfdi:Retenciones\u003e \u003ccfdi:Traslados\u003e \u003ccfdi:Traslado Base=\"1.00\" Impuesto=\"002\" TipoFactor=\"Tasa\" TasaOCuota=\"1.600000\" Importe=\"360000\"/\u003e \u003c/cfdi:Traslados\u003e \u003c/cfdi:Impuestos\u003e \u003ccfdi:Complemento\u003e\u003c/cfdi:Complemento\u003e \u003c/cfdi:Comprobante\u003e \"\"\"; /// \u003csummary\u003e /// Invoca al servicio web para obtener solo el TFD de un CFDI de forma asíncrona. /// \u003c/summary\u003e /// \u003cparam name=\"apiKey\"\u003eLa credencial de acceso al servicio.\u003c/param\u003e /// \u003cparam name=\"xmlCfdi\"\u003eEl contenido del CFDI a timbrar.\u003c/param\u003e /// \u003creturns\u003eUn objeto RespuestaTimbradoTFD con el resultado de la operación.\u003c/returns\u003e public async Task\u003cRespuestaTimbradoTFD\u003e TimbrarTFDAsync(string apiKey, string xmlCfdi) { using var client = new ServicioTimbradoWSPortTypeClient(\"ServicioTimbradoWSPort\"); try { // La operación se llama 'timbrarTFD' en el servicio web var response = await client.timbrarTFDAsync(apiKey, xmlCfdi); return new RespuestaTimbradoTFD { Code = response.code, Message = response.message, Data = response.data // Contiene solo el XML del TFD }; } catch (FaultException\u003cRespuestaTimbradoTFD\u003e ex) { _logger.LogError(ex, \"Error SOAP: {Code} - {Message}\", ex.Detail.code, ex.Detail.message); throw; } catch (CommunicationException ex) { _logger.LogError(ex, \"Error de comunicación con el servicio\"); throw; } catch (TimeoutException ex) { _logger.LogError(ex, \"Timeout en la comunicación\"); throw; } } /// \u003csummary\u003e /// Define la estructura del objeto de respuesta para mayor claridad. /// \u003c/summary\u003e public class RespuestaTimbradoTFD { public string? Code { get; set; } public string? Message { get; set; } public string? Data { get; set; } } // Ejemplo de uso de TimbrarTFDAsync public async Task EjemploUsoTimbrarTFDAsync() { string apiKey = \"TU_API_KEY_AQUI\"; string xmlCfdi = GenerarCfdiParaTimbrar(); try { var resultado = await TimbrarTFDAsync(apiKey, xmlCfdi); if (resultado.Code == \"200\") { Console.WriteLine(\"¡Timbrado para TFD Exitoso!\"); Console.WriteLine(\"Mensaje: \" + resultado.Message); Console.WriteLine(\"--- XML del Timbre Fiscal Digital (TFD) ---\"); Console.WriteLine(resultado.Data); } else { Console.WriteLine(\"Error durante el timbrado TFD:\"); Console.WriteLine(\"Código: \" + resultado.Code); Console.WriteLine(\"Mensaje: \" + resultado.Message); } } catch (Exception ex) { Console.WriteLine(\"Ocurrió una excepción: \" + ex.Message); } } Herramienta wsimport Java incluye la herramienta wsimport en el JDK para generar las clases cliente a partir de un WSDL.\nEjecuta el siguiente comando en tu terminal para el ambiente de DESARROLLO:\nwsimport -keep -p com.facturaloplus.cliente https://dev.facturaloplus.com/ws/servicio.do?wsdl -keep: Conserva los archivos fuente .java generados.\n-p: Especifica el paquete (package) donde se guardarán las clases.\nImplementación // --- Archivo: RespuestaTimbradoTFD.java --- package com.facturaloplus.cliente; // POJO para encapsular la respuesta de la operación timbrarTFD. public class RespuestaTimbradoTFD { private String code; private String message; private String data; // Contendrá el XML del TFD // Getters y Setters public String getCode() { return code; } public void setCode(String code) { this.code = code; } public String getMessage() { return message; } public void setMessage(String message) { this.message = message; } public String getData() { return data; } public void setData(String data) { this.data = data; } } // --- Archivo: TimbradoService.java --- package com.facturaloplus.cliente; import javax.xml.ws.Service; import javax.xml.ws.WebServiceException; import javax.xml.ws.soap.SOAPFaultException; import java.time.LocalDateTime; import java.time.format.DateTimeFormatter; import java.util.concurrent.CompletableFuture; import java.util.concurrent.ExecutorService; import java.util.concurrent.Executors; import java.util.logging.Level; import java.util.logging.Logger; public class TimbradoService { private static final Logger logger = Logger.getLogger(TimbradoService.class.getName()); private final ExecutorService executor = Executors.newFixedThreadPool(5); public String generarXmlCfdiEjemplo() { String fechaActual = LocalDateTime.now().format(DateTimeFormatter.ofPattern(\"yyyy-MM-dd'T'HH:mm:ss\")); return \"\"\" \u003c?xml version=\"1.0\" encoding=\"UTF-8\"?\u003e \u003ccfdi:Comprobante xmlns:cfdi=\"http://www.sat.gob.mx/cfd/4\" xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\" xsi:schemaLocation=\"http://www.sat.gob.mx/cfd/4 cfdv40.xsd\" Version=\"4.0\" Serie=\"F\" Folio=\"123\" Fecha=\"%s\" SubTotal=\"100.00\" TipoCambio=\"1.0\" Serie=\"A\" Moneda=\"MXN\" Descuento=\"0.00\" Total=\"116.00\" TipoDeComprobante=\"I\" Exportacion=\"01\" MetodoPago=\"PUE\" CondicionesDePago=\"CONDICIONES\" FormaPago=\"01\" Confirmacion=\"A1234\" NoCertificado=\"30001000000300023708\" Certificado=\"\" Sello=\"\" LugarExpedicion=\"64000\"\u003e \u003ccfdi:InformacionGlobal Meses=\"18\" Año=\"2025\" Periodicidad=\"05\" /\u003e \u003ccfdi:CfdiRelacionados TipoRelacion=\"09\"\u003e \u003ccfdi:CfdiRelacionado UUID=\"ED1752FE-E865-4FF2-BFE1-0F552E770DC9\" /\u003e \u003c/cfdi:CfdiRelacionados\u003e \u003ccfdi:Emisor FacAtrAdquirente=\"0123456789\" Rfc=\"ABC010101XYZ\" Nombre=\"Empresa Ejemplo\" RegimenFiscal=\"601\"/\u003e \u003ccfdi:Receptor Rfc=\"XAXX010101000\" Nombre=\"Publico en General\" DomicilioFiscalReceptor=\"64000\" RegimenFiscalReceptor=\"616\" ResidenciaFiscal=\"MEX\" UsoCFDI=\"G03\"/\u003e \u003ccfdi:Conceptos\u003e \u003ccfdi:Concepto ObjetoImp=\"01\" ClaveProdServ=\"01010101\" ClaveUnidad=\"C81\" NoIdentificacion=\"00001\" Cantidad=\"1.5\" Unidad=\"TONELADA\" Descripcion=\"ACERO\" ValorUnitario=\"1500000\" Importe=\"2250000\"\u003e \u003ccfdi:Impuestos\u003e \u003ccfdi:Traslados\u003e \u003ccfdi:Traslado Base=\"100.00\" Impuesto=\"002\" TipoFactor=\"Tasa\" TasaOCuota=\"0.160000\" Importe=\"16.00\"/\u003e \u003c/cfdi:Traslados\u003e \u003ccfdi:Retenciones\u003e \u003ccfdi:Retencion Base=\"2250000\" Impuesto=\"001\" TipoFactor=\"Tasa\" TasaOCuota=\"0.300000\" Importe=\"247500\"/\u003e \u003c/cfdi:Retenciones\u003e \u003c/cfdi:Impuestos\u003e \u003ccfdi:CuentaPredial Numero=\"51888\"/\u003e \u003c/cfdi:Concepto\u003e \u003c/cfdi:Conceptos\u003e \u003ccfdi:Impuestos TotalImpuestosRetenidos=\"247500\" TotalImpuestosTrasladados=\"360000\"\u003e \u003ccfdi:Retenciones\u003e \u003ccfdi:Retencion Impuesto=\"001\" Importe=\"247000\"/\u003e \u003ccfdi:Retencion Impuesto=\"003\" Importe=\"500\"/\u003e \u003c/cfdi:Retenciones\u003e \u003ccfdi:Traslados\u003e \u003ccfdi:Traslado Base=\"1.00\" Impuesto=\"002\" TipoFactor=\"Tasa\" TasaOCuota=\"1.600000\" Importe=\"360000\"/\u003e \u003c/cfdi:Traslados\u003e \u003c/cfdi:Impuestos\u003e \u003ccfdi:Complemento\u003e\u003c/cfdi:Complemento\u003e \u003c/cfdi:Comprobante\u003e \"\"\".formatted(fechaActual); } public CompletableFuture\u003cRespuestaTimbradoTFD\u003e timbrarTFDAsync(String apiKey, String xmlCfdi) { return CompletableFuture.supplyAsync(() -\u003e { try { ServicioTimbradoWS service = new ServicioTimbradoWS(); ServicioTimbradoWSPortType port = service.getServicioTimbradoWSPort(); logger.info(\"Iniciando timbrado para obtener TFD.\"); // La clase 'Respuesta' es generada por wsimport Respuesta response = port.timbrarTFD(apiKey, xmlCfdi); RespuestaTimbradoTFD resultado = new RespuestaTimbradoTFD(); resultado.setCode(response.getCode()); resultado.setMessage(response.getMessage()); resultado.setData(response.getData()); return resultado; } catch (SOAPFaultException ex) { logger.log(Level.SEVERE, \"Error SOAP: \" + ex.getFault().getFaultString(), ex); throw new RuntimeException(\"Error del servicio: \" + ex.getFault().getFaultString(), ex); } catch (WebServiceException ex) { logger.log(Level.SEVERE, \"Error de comunicación con el servicio.\", ex); throw new RuntimeException(\"Error de comunicación.\", ex); } }, executor); } public void shutdown() { executor.shutdown(); } } // --- Archivo: Main.java (Ejemplo de uso) --- package com.facturaloplus.cliente; import java.util.concurrent.CompletableFuture; public class Main { public static void main(String[] args) { TimbradoService timbradoService = new TimbradoService(); String miApiKey = \"TU_API_KEY_AQUI\"; String xmlParaTimbrar = timbradoService.generarXmlCfdiEjemplo(); CompletableFuture\u003cRespuestaTimbradoTFD\u003e future = timbradoService.timbrarTFDAsync(miApiKey, xmlParaTimbrar); future.whenComplete((resultado, ex) -\u003e { if (ex != null) { System.err.println(\"\\nOcurrió una excepción: \" + ex.getMessage()); } else { if (\"200\".equals(resultado.getCode())) { System.out.println(\"\\n¡Timbrado para TFD Exitoso!\"); System.out.println(\"Mensaje: \" + resultado.getMessage()); System.out.println(\"\\n--- XML del Timbre Fiscal Digital (TFD) ---\"); System.out.println(resultado.getData()); } else { System.err.println(\"\\nError durante el timbrado TFD:\"); System.err.println(\"Código: \" + resultado.getCode()); System.err.println(\"Mensaje: \" + resultado.getMessage()); } } timbradoService.shutdown(); }); future.join(); } } Herramienta Zeep Instala la librería zeep usando pip:\npip install zeep Implementación # --- Archivo: timbrado_service.py --- import asyncio import logging from datetime import datetime from zeep import Client from zeep.asyncio import AsyncClient from zeep.exceptions import Fault, TransportError from dataclasses import dataclass logging.basicConfig(level=logging.INFO, format='%(asctime)s - %(levelname)s - %(message)s') WSDL_URL_DESARROLLO = \"https://dev.facturaloplus.com/ws/servicio.do?wsdl\" @dataclass class RespuestaTimbradoTFD: \"\"\"Clase de datos para encapsular la respuesta del servicio timbrarTFD.\"\"\" code: str = None message: str = None data: str = None # Contendrá el XML del TFD class TimbradoService: def __init__(self, wsdl_url: str): self.wsdl_url = wsdl_url self.async_client = AsyncClient(self.wsdl_url) def generar_xml_cfdi_ejemplo(self) -\u003e str: fecha_actual = datetime.utcnow().strftime('%Y-%m-%dT%H:%M:%S') return f\"\"\" \u003c?xml version=\"1.0\" encoding=\"UTF-8\"?\u003e \u003ccfdi:Comprobante xmlns:cfdi=\"http://www.sat.gob.mx/cfd/4\" xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\" xsi:schemaLocation=\"http://www.sat.gob.mx/cfd/4 cfdv40.xsd\" Version=\"4.0\" Serie=\"F\" Folio=\"123\" Fecha=\"{fecha_actual}\" SubTotal=\"100.00\" TipoCambio=\"1.0\" Serie=\"A\" Moneda=\"MXN\" Descuento=\"0.00\" Total=\"116.00\" TipoDeComprobante=\"I\" Exportacion=\"01\" MetodoPago=\"PUE\" CondicionesDePago=\"CONDICIONES\" FormaPago=\"01\" Confirmacion=\"A1234\" NoCertificado=\"30001000000300023708\" Certificado=\"\" Sello=\"\" LugarExpedicion=\"64000\"\u003e \u003ccfdi:InformacionGlobal Meses=\"18\" Año=\"2025\" Periodicidad=\"05\" /\u003e \u003ccfdi:CfdiRelacionados TipoRelacion=\"09\"\u003e \u003ccfdi:CfdiRelacionado UUID=\"ED1752FE-E865-4FF2-BFE1-0F552E770DC9\" /\u003e \u003c/cfdi:CfdiRelacionados\u003e \u003ccfdi:Emisor FacAtrAdquirente=\"0123456789\" Rfc=\"ABC010101XYZ\" Nombre=\"Empresa Ejemplo\" RegimenFiscal=\"601\"/\u003e \u003ccfdi:Receptor Rfc=\"XAXX010101000\" Nombre=\"Publico en General\" DomicilioFiscalReceptor=\"64000\" RegimenFiscalReceptor=\"616\" ResidenciaFiscal=\"MEX\" UsoCFDI=\"G03\"/\u003e \u003ccfdi:Conceptos\u003e \u003ccfdi:Concepto ObjetoImp=\"01\" ClaveProdServ=\"01010101\" ClaveUnidad=\"C81\" NoIdentificacion=\"00001\" Cantidad=\"1.5\" Unidad=\"TONELADA\" Descripcion=\"ACERO\" ValorUnitario=\"1500000\" Importe=\"2250000\"\u003e \u003ccfdi:Impuestos\u003e \u003ccfdi:Traslados\u003e \u003ccfdi:Traslado Base=\"100.00\" Impuesto=\"002\" TipoFactor=\"Tasa\" TasaOCuota=\"0.160000\" Importe=\"16.00\"/\u003e \u003c/cfdi:Traslados\u003e \u003ccfdi:Retenciones\u003e \u003ccfdi:Retencion Base=\"2250000\" Impuesto=\"001\" TipoFactor=\"Tasa\" TasaOCuota=\"0.300000\" Importe=\"247500\"/\u003e \u003c/cfdi:Retenciones\u003e \u003c/cfdi:Impuestos\u003e \u003ccfdi:CuentaPredial Numero=\"51888\"/\u003e \u003c/cfdi:Concepto\u003e \u003c/cfdi:Conceptos\u003e \u003ccfdi:Impuestos TotalImpuestosRetenidos=\"247500\" TotalImpuestosTrasladados=\"360000\"\u003e \u003ccfdi:Retenciones\u003e \u003ccfdi:Retencion Impuesto=\"001\" Importe=\"247000\"/\u003e \u003ccfdi:Retencion Impuesto=\"003\" Importe=\"500\"/\u003e \u003c/cfdi:Retenciones\u003e \u003ccfdi:Traslados\u003e \u003ccfdi:Traslado Base=\"1.00\" Impuesto=\"002\" TipoFactor=\"Tasa\" TasaOCuota=\"1.600000\" Importe=\"360000\"/\u003e \u003c/cfdi:Traslados\u003e \u003c/cfdi:Impuestos\u003e \u003ccfdi:Complemento\u003e\u003c/cfdi:Complemento\u003e \u003c/cfdi:Comprobante\u003e \"\"\" async def timbrar_tfd_async(self, api_key: str, xml_cfdi: str) -\u003e RespuestaTimbradoTFD: \"\"\"Invoca al servicio web para obtener solo el TFD de un CFDI.\"\"\" try: logging.info(\"Iniciando timbrado para obtener TFD.\") response = await self.async_client.service.timbrarTFD(apikey=api_key, xmlCFDI=xml_cfdi) return RespuestaTimbradoTFD( code=response.code, message=response.message, data=response.data ) except Fault as ex: logging.error(f\"Error SOAP (Fault): {ex.message}\") raise ConnectionError(f\"Error del servicio: {ex.message}\") from ex except TransportError as ex: logging.error(f\"Error de comunicación: {ex}\") raise # --- Archivo: main.py (Ejemplo de uso) --- async def main(): service = TimbradoService(WSDL_URL_DESARROLLO) mi_api_key = \"TU_API_KEY_AQUI\" xml_para_timbrar = service.generar_xml_cfdi_ejemplo() try: resultado = await service.timbrar_tfd_async(mi_api_key, xml_para_timbrar) if resultado.code == \"200\": print(\"\\033[92m\\n¡Timbrado para TFD Exitoso!\\033[0m\") print(f\"Mensaje: {resultado.message}\") print(\"\\n--- XML del Timbre Fiscal Digital (TFD) ---\") print(resultado.data) else: print(f\"\\033[91m\\nError durante el timbrado TFD:\\033[0m\") print(f\"Código: {resultado.code}\") print(f\"Mensaje: {resultado.message}\") except Exception as ex: print(f\"\\033[91m\\nOcurrió una excepción: {ex}\\033[0m\") if __name__ == \"__main__\": asyncio.run(main()) Herramienta SoapClient Asegúrate de que la extensión php-soap esté habilitada en tu php.ini.\nImplementación \u003c?php // --- Archivo: TimbradoTFD.php --- ini_set('display_errors', 1); error_reporting(E_ALL); class RespuestaTimbradoTFD { public ?string $code = null; public ?string $message = null; public ?string $data = null; // Contendrá el XML del TFD } class TimbradoService { private string $wsdlUrl; public function __construct(string $wsdlUrl) { $this-\u003ewsdlUrl = $wsdlUrl; } public function generarXmlCfdiEjemplo(): string { $fechaActual = gmdate('Y-m-d\\TH:i:s'); return \u003c\u003c\u003cXML \u003c?xml version=\"1.0\" encoding=\"UTF-8\"?\u003e \u003ccfdi:Comprobante xmlns:cfdi=\"http://www.sat.gob.mx/cfd/4\" xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\" xsi:schemaLocation=\"http://www.sat.gob.mx/cfd/4 cfdv40.xsd\" Version=\"4.0\" Serie=\"F\" Folio=\"123\" Fecha=\"{$fechaActual}\" SubTotal=\"100.00\" TipoCambio=\"1.0\" Serie=\"A\" Moneda=\"MXN\" Descuento=\"0.00\" Total=\"116.00\" TipoDeComprobante=\"I\" Exportacion=\"01\" MetodoPago=\"PUE\" CondicionesDePago=\"CONDICIONES\" FormaPago=\"01\" Confirmacion=\"A1234\" NoCertificado=\"30001000000300023708\" Certificado=\"\" Sello=\"\" LugarExpedicion=\"64000\"\u003e \u003ccfdi:InformacionGlobal Meses=\"18\" Año=\"2025\" Periodicidad=\"05\" /\u003e \u003ccfdi:CfdiRelacionados TipoRelacion=\"09\"\u003e \u003ccfdi:CfdiRelacionado UUID=\"ED1752FE-E865-4FF2-BFE1-0F552E770DC9\" /\u003e \u003c/cfdi:CfdiRelacionados\u003e \u003ccfdi:Emisor FacAtrAdquirente=\"0123456789\" Rfc=\"ABC010101XYZ\" Nombre=\"Empresa Ejemplo\" RegimenFiscal=\"601\"/\u003e \u003ccfdi:Receptor Rfc=\"XAXX010101000\" Nombre=\"Publico en General\" DomicilioFiscalReceptor=\"64000\" RegimenFiscalReceptor=\"616\" ResidenciaFiscal=\"MEX\" UsoCFDI=\"G03\"/\u003e \u003ccfdi:Conceptos\u003e \u003ccfdi:Concepto ObjetoImp=\"01\" ClaveProdServ=\"01010101\" ClaveUnidad=\"C81\" NoIdentificacion=\"00001\" Cantidad=\"1.5\" Unidad=\"TONELADA\" Descripcion=\"ACERO\" ValorUnitario=\"1500000\" Importe=\"2250000\"\u003e \u003ccfdi:Impuestos\u003e \u003ccfdi:Traslados\u003e \u003ccfdi:Traslado Base=\"100.00\" Impuesto=\"002\" TipoFactor=\"Tasa\" TasaOCuota=\"0.160000\" Importe=\"16.00\"/\u003e \u003c/cfdi:Traslados\u003e \u003ccfdi:Retenciones\u003e \u003ccfdi:Retencion Base=\"2250000\" Impuesto=\"001\" TipoFactor=\"Tasa\" TasaOCuota=\"0.300000\" Importe=\"247500\"/\u003e \u003c/cfdi:Retenciones\u003e \u003c/cfdi:Impuestos\u003e \u003ccfdi:CuentaPredial Numero=\"51888\"/\u003e \u003c/cfdi:Concepto\u003e \u003c/cfdi:Conceptos\u003e \u003ccfdi:Impuestos TotalImpuestosRetenidos=\"247500\" TotalImpuestosTrasladados=\"360000\"\u003e \u003ccfdi:Retenciones\u003e \u003ccfdi:Retencion Impuesto=\"001\" Importe=\"247000\"/\u003e \u003ccfdi:Retencion Impuesto=\"003\" Importe=\"500\"/\u003e \u003c/cfdi:Retenciones\u003e \u003ccfdi:Traslados\u003e \u003ccfdi:Traslado Base=\"1.00\" Impuesto=\"002\" TipoFactor=\"Tasa\" TasaOCuota=\"1.600000\" Importe=\"360000\"/\u003e \u003c/cfdi:Traslados\u003e \u003c/cfdi:Impuestos\u003e \u003ccfdi:Complemento\u003e\u003c/cfdi:Complemento\u003e \u003c/cfdi:Comprobante\u003e XML; } public function timbrarTFD(string $apiKey, string $xmlCfdi): RespuestaTimbradoTFD { $respuesta = new RespuestaTimbradoTFD(); try { $options = [ 'trace' =\u003e 1, 'exceptions' =\u003e true, 'cache_wsdl' =\u003e WSDL_CACHE_NONE ]; $soapClient = new SoapClient($this-\u003ewsdlUrl, $options); $params = [ 'apikey' =\u003e $apiKey, 'xmlCFDI' =\u003e $xmlCfdi ]; // Llamar a la operación 'timbrarTFD' $response = $soapClient-\u003etimbrarTFD($params); $respuesta-\u003ecode = $response-\u003ereturn-\u003ecode ?? null; $respuesta-\u003emessage = $response-\u003ereturn-\u003emessage ?? null; $respuesta-\u003edata = $response-\u003ereturn-\u003edata ?? null; } catch (SoapFault $e) { error_log(\"Error SOAP: \" . $e-\u003egetMessage()); $respuesta-\u003ecode = \"FAULT\"; $respuesta-\u003emessage = \"Error en la comunicación SOAP: \" . $e-\u003egetMessage(); } return $respuesta; } } // --- Archivo: index.php (Ejemplo de uso) --- // require_once 'TimbradoTFD.php'; $wsdlDesarrollo = \"https://dev.facturaloplus.com/ws/servicio.do?wsdl\"; $timbradoService = new TimbradoService($wsdlDesarrollo); $miApiKey = getenv('TIMBRADO_API_KEY') ?: \"TU_API_KEY_AQUI\"; $xmlParaTimbrar = $timbradoService-\u003egenerarXmlCfdiEjemplo(); header('Content-Type: text/plain; charset=utf-8'); $resultado = $timbradoService-\u003etimbrarTFD($miApiKey, $xmlParaTimbrar); if ($resultado-\u003ecode === '200') { echo \"¡Timbrado para TFD Exitoso!\\n\"; echo \"Mensaje: {$resultado-\u003emessage}\\n\"; echo \"\\n--- XML del Timbre Fiscal Digital (TFD) ---\\n\"; echo $resultado-\u003edata; } else { echo \"Error durante el timbrado TFD:\\n\"; echo \"Código: {$resultado-\u003ecode}\\n\"; echo \"Mensaje: {$resultado-\u003emessage}\\n\"; } ?\u003e Respuesta (Response) El campo data contendrá únicamente el XML del Timbre Fiscal Digital (TFD).\n\u003c?xml version=\"1.0\" encoding=\"UTF-8\"?\u003e \u003cSOAP-ENV:Envelope SOAP-ENV:encodingStyle=\"http://schemas.xmlsoap.org/soap/encoding/\" xmlns:SOAP-ENV=\"http://schemas.xmlsoap.org/soap/envelope/\" xmlns:xsd=\"http://www.w3.org/2001/XMLSchema\" xmlns:xsi=\"http://www.w3.org/2001/XMLSchema- instance\" xmlns:SOAP-ENC=\"http://schemas.xmlsoap.org/soap/encoding/\" xmlns:tns=\"urn:ws_api\"\u003e \u003cSOAP-ENV:Body\u003e \u003cns1:timbrarTFDResponse xmlns:ns1=\"urn:ws_api\"\u003e \u003creturn xsi:type=\"tns:RespuestaTimbrado\"\u003e \u003ccode xsi:type=\"xsd:string\"\u003eCÓDIGO\u003c/code\u003e \u003cmessage xsi:type=\"xsd:string\"\u003eMENSAJE\u003c/message\u003e \u003cdata xsi:type=\"xsd:string\"\u003e \u003c![CDATA[CFDI TIMBRADO]]\u003e \u003c/data\u003e \u003c/return\u003e \u003c/ns1:timbrarTFDResponse\u003e \u003c/SOAP-ENV:Body\u003e \u003c/SOAP-ENV:Envelope\u003e Códigos de respuesta Los códigos de respuesta para el timbrado de CFDI son importantes para entender el resultado de la solicitud. A continuación se detallan los códigos más comunes que puedes recibir al realizar una solicitud de timbrado a través de la API.\rCódigo\rDescripción\r200\rSolicitud procesada con éxito\r300\rAPI KEY Inválida o inexistente\r301\rXML mal formado\r302\rEl sello del emisor no es válido\r303\rEl RFC del CSD del emisor no corresponde al RFC del Emisor\r304\rCSD del Emisor ha sido revobado\r305\rLa fecha de emisión no está dentro de la vigencia del CSD del Emisor\r306\rLa llave utilizada para sellar debe ser un CSD\r307\rEl CFDI contiene un timbre previo\r308\rEl CSD del emisor no ha sido firmado por uno de los Certificados de autoridad del SAT\r401\rEl rango de la fecha de generación no debe de ser mayor a 72 horas para la emisión del timbre\r402\rRFC del emisor no se encuentra en el régimen de contribuyentes (Lista de validación de régimen) LCO","timbrartfd#timbrarTFD":""},"title":"timbradoTFD"},"/facturotas.docs/api/timbrado/timbrarjson/":{"data":{"#":"timbrarJSONEsta sección detalla la operación del servicio de timbrado a partir de un layout JSON, permitiendo generar, sellar y obtener el XML timbrado de un Comprobante Fiscal Digital (CFDI) sin necesidad de construir el XML manualmente.\nDescripción de la Operación Esta operación facilita la creación de un CFDI (versiones 3.3 o 4.0) a partir de un archivo JSON. El servicio se encarga de construir la estructura del XML, sellarlo con los certificados proporcionados y devolver el XML timbrado completo, junto con su folio fiscal (UUID) y el sello digital del SAT.\nParámetros de Entrada (Input) Parámetro Tipo de Dato Descripción apikey string Credencial de acceso al servicio (Solicita aquí). jsonB64 string Cadena en formato Base64 que contiene el layout JSON con la información del CFDI a generar (ver estructura abajo). Conversor Base 64 keyPEM string Contenido del archivo de la llave privada (.key) en formato PEM. cerPEM string Contenido del archivo del certificado de llave pública (.cer) en formato PEM. Parámetros de Salida (Output) - RespuestaTimbrado La respuesta de esta operación es idéntica a la de la operación timbrar.\nAtributo Tipo de Dato Descripción code string Código de respuesta de la operación. message string Mensaje detallado de la respuesta. data string XML del CFDI timbrado en caso de éxito. Estructura del JSON de Entrada El JSON enviado en el parámetro jsonB64 debe seguir la siguiente estructura. Los valores vacíos deben enviarse como \"\". Conversor Base 64\n{ \"Comprobante\": { \"Version\": \"4.0\", \"Serie\": \"\", \"Folio\": \"\", \"Fecha\": \"2025-07-04T12:00:00\", \"FormaPago\": \"01\", \"NoCertificado\": \"\", \"CondicionesDePago\": \"\", \"SubTotal\": \"100.00\", \"Descuento\": \"0.00\", \"Moneda\": \"MXN\", \"TipoCambio\": \"1\", \"Total\": \"116.00\", \"TipoDeComprobante\": \"I\", \"Exportacion\": \"01\", \"MetodoPago\": \"PUE\", \"LugarExpedicion\": \"64000\", \"Confirmacion\": \"\", \"Emisor\": { \"Rfc\": \"ABC010101XYZ\", \"Nombre\": \"Empresa Ejemplo SA de CV\", \"RegimenFiscal\": \"601\" }, \"Receptor\": { \"Rfc\": \"XAXX010101000\", \"Nombre\": \"Publico en General\", \"DomicilioFiscalReceptor\": \"64000\", \"RegimenFiscalReceptor\": \"616\", \"UsoCFDI\": \"G03\" }, \"Conceptos\": [ { \"ClaveProdServ\": \"01010101\", \"Cantidad\": \"1.0\", \"ClaveUnidad\": \"ACT\", \"Descripcion\": \"Producto de prueba\", \"ValorUnitario\": \"100.00\", \"Importe\": \"100.00\", \"ObjetoImp\": \"02\", \"Impuestos\": { \"Traslados\": [ { \"Base\": \"100.00\", \"Impuesto\": \"002\", \"TipoFactor\": \"Tasa\", \"TasaOCuota\": \"0.160000\", \"Importe\": \"16.00\" } ] } } ], \"Impuestos\": { \"TotalImpuestosTrasladados\": \"16.00\", \"Traslados\": [ { \"Base\": \"100.00\", \"Impuesto\": \"002\", \"TipoFactor\": \"Tasa\", \"TasaOCuota\": \"0.160000\", \"Importe\": \"16.00\" } ] } } } Ejemplo de Código Solicitud (Request) C#JavaPythonPHP Herramienta svcutil Descarga e instala la herramienta svcutil\nEjecuta el comando siguiente (DESARROLLO)\nsvcutil.exe https://dev.facturaloplus.com/ws/servicio.do?wsdl /out:ServicioTimbradoClient.cs /config:app.config Esto genera dos archivos: ServicioTimbradoClient.cs y la configuración en app.config\nImplementación using System; using System.IO; using System.Text; using System.Text.Json; using System.Threading.Tasks; // ... (Asegúrate de tener la referencia al cliente SOAP generado por svcutil) /// \u003csummary\u003e /// Genera dinámicamente el layout del CFDI en formato JSON. /// En una aplicación real, los valores se obtendrían de una base de datos o de la entrada del usuario. /// \u003c/summary\u003e /// \u003creturns\u003eUn string con el JSON del CFDI.\u003c/returns\u003e private static string GetJsonLayout() { // Usar un objeto anónimo para construir la estructura y luego serializarla. var cfdiLayout = new { Comprobante = new { Version = \"4.0\", Serie = \"F\", Folio = \"123\", Fecha = \"2025-07-04T12:00:00\", FormaPago = \"01\", SubTotal = \"100.00\", Moneda = \"MXN\", Total = \"116.00\", TipoDeComprobante = \"I\", Exportacion = \"01\", MetodoPago = \"PUE\", LugarExpedicion = \"64000\", Emisor = new { Rfc = \"ABC010101XYZ\", Nombre = \"Empresa Ejemplo SA de CV\", RegimenFiscal = \"601\" }, Receptor = new { Rfc = \"XAXX010101000\", Nombre = \"Publico en General\", DomicilioFiscalReceptor = \"64000\", RegimenFiscalReceptor = \"616\", UsoCFDI = \"G03\" }, Conceptos = new[] { new { ClaveProdServ = \"01010101\", Cantidad = \"1.0\", ClaveUnidad = \"ACT\", Descripcion = \"Producto de prueba\", ValorUnitario = \"100.00\", Importe = \"100.00\", ObjetoImp = \"02\", Impuestos = new { Traslados = new[] { new { Base = \"100.00\", Impuesto = \"002\", TipoFactor = \"Tasa\", TasaOCuota = \"0.160000\", Importe = \"16.00\" } } } } }, Impuestos = new { TotalImpuestosTrasladados = \"16.00\", Traslados = new[] { new { Base = \"100.00\", Impuesto = \"002\", TipoFactor = \"Tasa\", TasaOCuota = \"0.160000\", Importe = \"16.00\" } } } } }; return JsonSerializer.Serialize(cfdiLayout); } /// \u003csummary\u003e /// Prepara y codifica los datos para la operación timbrarJSON. /// \u003c/summary\u003e public async Task\u003cRespuestaTimbrado\u003e TimbrarJsonAsync(string apiKey, string jsonLayout, string keyPemPath, string cerPemPath) { // 1. Codificar el JSON a Base64 var jsonBytes = Encoding.UTF8.GetBytes(jsonLayout); var jsonB64 = Convert.ToBase64String(jsonBytes); // 2. Leer el contenido de los archivos PEM var keyPem = await File.ReadAllTextAsync(keyPemPath); var cerPem = await File.ReadAllTextAsync(cerPemPath); // 3. Invocar al servicio web using var client = new ServicioTimbradoWSPortTypeClient(\"ServicioTimbradoWSPort\"); try { // Asumiendo que la operación en el WSDL se llama 'timbrarJSON' var response = await client.timbrarJSONAsync(apiKey, jsonB64, keyPem, cerPem); return new RespuestaTimbrado { Code = response.code, Message = response.message, Data = response.data }; } catch (Exception ex) { // Manejo de errores (FaultException, etc.) Console.WriteLine($\"Error al timbrar con JSON: {ex.Message}\"); throw; } } // Ejemplo de uso public async Task EjemploUsoTimbrarJsonAsync() { string apiKey = \"TU_API_KEY_AQUI\"; string jsonLayout = GetJsonLayout(); // Carga el layout dinámicamente string keyPemFile = \"ruta/a/tu/llave.key.pem\"; string cerPemFile = \"ruta/a/tu/certificado.cer.pem\"; var resultado = await TimbrarJsonAsync(apiKey, jsonLayout, keyPemFile, cerPemFile); if (resultado?.Code == \"200\") { Console.WriteLine(\"¡Timbrado con JSON Exitoso!\"); Console.WriteLine(resultado.Data); } else { Console.WriteLine($\"Error: {resultado?.Code} - {resultado?.Message}\"); } } Herramienta wsimport Java incluye la herramienta wsimport en el JDK para generar las clases cliente a partir de un WSDL.\nEjecuta el siguiente comando en tu terminal para el ambiente de DESARROLLO:\nwsimport -keep -p com.facturaloplus.cliente https://dev.facturaloplus.com/ws/servicio.do?wsdl -keep: Conserva los archivos fuente .java generados.\n-p: Especifica el paquete (package) donde se guardarán las clases.\nImplementación import java.nio.charset.StandardCharsets; import java.nio.file.Files; import java.nio.file.Paths; import java.util.Base64; import java.util.concurrent.CompletableFuture; // ... (Asegúrate de tener las clases generadas por wsimport) public class TimbradoJsonService { // ... (Definición de ExecutorService y Logger) /** * Genera dinámicamente el layout del CFDI en formato JSON. * En una aplicación real, los valores se obtendrían de una base de datos o de la entrada del usuario. * Se recomienda usar una librería como Gson o Jackson para construir el JSON de forma más robusta. */ public static String getJsonLayout() { // Usamos un Text Block de Java 15+ para legibilidad. return \"\"\" { \"Comprobante\": { \"Version\": \"4.0\", \"Serie\": \"F\", \"Folio\": \"123\", \"Fecha\": \"2025-07-04T12:00:00\", \"FormaPago\": \"01\", \"SubTotal\": \"100.00\", \"Moneda\": \"MXN\", \"Total\": \"116.00\", \"TipoDeComprobante\": \"I\", \"Exportacion\": \"01\", \"MetodoPago\": \"PUE\", \"LugarExpedicion\": \"64000\", \"Emisor\": { \"Rfc\": \"ABC010101XYZ\", \"Nombre\": \"Empresa Ejemplo SA de CV\", \"RegimenFiscal\": \"601\" }, \"Receptor\": { \"Rfc\": \"XAXX010101000\", \"Nombre\": \"Publico en General\", \"DomicilioFiscalReceptor\": \"64000\", \"RegimenFiscalReceptor\": \"616\", \"UsoCFDI\": \"G03\" }, \"Conceptos\": [ { \"ClaveProdServ\": \"01010101\", \"Cantidad\": \"1.0\", \"ClaveUnidad\": \"ACT\", \"Descripcion\": \"Producto de prueba\", \"ValorUnitario\": \"100.00\", \"Importe\": \"100.00\", \"ObjetoImp\": \"02\", \"Impuestos\": { \"Traslados\": [ { \"Base\": \"100.00\", \"Impuesto\": \"002\", \"TipoFactor\": \"Tasa\", \"TasaOCuota\": \"0.160000\", \"Importe\": \"16.00\" } ] } } ], \"Impuestos\": { \"TotalImpuestosTrasladados\": \"16.00\", \"Traslados\": [ { \"Base\": \"100.00\", \"Impuesto\": \"002\", \"TipoFactor\": \"Tasa\", \"TasaOCuota\": \"0.160000\", \"Importe\": \"16.00\" } ] } } } \"\"\"; } public CompletableFuture\u003cRespuestaTimbrado\u003e timbrarJsonAsync(String apiKey, String jsonLayout, String keyPemPath, String cerPemPath) { return CompletableFuture.supplyAsync(() -\u003e { try { // 1. Codificar JSON a Base64 String jsonB64 = Base64.getEncoder().encodeToString(jsonLayout.getBytes(StandardCharsets.UTF_8)); // 2. Leer archivos PEM String keyPem = new String(Files.readAllBytes(Paths.get(keyPemPath))); String cerPem = new String(Files.readAllBytes(Paths.get(cerPemPath))); // 3. Llamar al servicio ServicioTimbradoWS service = new ServicioTimbradoWS(); ServicioTimbradoWSPortType port = service.getServicioTimbradoWSPort(); // Asumiendo que la operación se llama 'timbrarJSON' Respuesta response = port.timbrarJSON(apiKey, jsonB64, keyPem, cerPem); RespuestaTimbrado resultado = new RespuestaTimbrado(); resultado.setCode(response.getCode()); resultado.setMessage(response.getMessage()); resultado.setData(response.getData()); return resultado; } catch (Exception ex) { // Manejo de errores throw new RuntimeException(\"Error al timbrar con JSON\", ex); } }, executor); } // Ejemplo de uso public static void main(String[] args) { TimbradoJsonService service = new TimbradoJsonService(); String apiKey = \"TU_API_KEY_AQUI\"; String keyPem = \"ruta/a/tu/llave.key.pem\"; String cerPem = \"ruta/a/tu/certificado.cer.pem\"; String jsonLayout = getJsonLayout(); // Carga el layout dinámicamente service.timbrarJsonAsync(apiKey, jsonLayout, keyPem, cerPem) .whenComplete((resultado, ex) -\u003e { if (ex != null) { System.err.println(\"Error: \" + ex.getMessage()); } else if (\"200\".equals(resultado.getCode())) { System.out.println(\"¡Timbrado con JSON Exitoso!\"); System.out.println(resultado.getData()); } else { System.err.println(\"Error: \" + resultado.getCode() + \" - \" + resultado.getMessage()); } service.shutdown(); }).join(); } } Herramienta Zeep Para interactuar con servicios SOAP en Python, la librería zeep es una excelente opción. Proporciona una interfaz limpia y moderna.\nInstala la librería usando pip:\npip install zeep Implementación import asyncio import base64 import json from zeep.asyncio import AsyncClient # ... (Definición de RespuestaTimbrado y configuración de logging) def get_json_layout() -\u003e dict: \"\"\" Genera dinámicamente el layout del CFDI como un diccionario de Python. En una aplicación real, los valores se obtendrían de una base de datos o de la entrada del usuario. \"\"\" return { \"Comprobante\": { \"Version\": \"4.0\", \"Serie\": \"F\", \"Folio\": \"123\", \"Fecha\": \"2025-07-04T12:00:00\", \"FormaPago\": \"01\", \"SubTotal\": \"100.00\", \"Moneda\": \"MXN\", \"Total\": \"116.00\", \"TipoDeComprobante\": \"I\", \"Exportacion\": \"01\", \"MetodoPago\": \"PUE\", \"LugarExpedicion\": \"64000\", \"Emisor\": { \"Rfc\": \"ABC010101XYZ\", \"Nombre\": \"Empresa Ejemplo SA de CV\", \"RegimenFiscal\": \"601\" }, \"Receptor\": { \"Rfc\": \"XAXX010101000\", \"Nombre\": \"Publico en General\", \"DomicilioFiscalReceptor\": \"64000\", \"RegimenFiscalReceptor\": \"616\", \"UsoCFDI\": \"G03\" }, \"Conceptos\": [ { \"ClaveProdServ\": \"01010101\", \"Cantidad\": \"1.0\", \"ClaveUnidad\": \"ACT\", \"Descripcion\": \"Producto de prueba\", \"ValorUnitario\": \"100.00\", \"Importe\": \"100.00\", \"ObjetoImp\": \"02\", \"Impuestos\": { \"Traslados\": [ { \"Base\": \"100.00\", \"Impuesto\": \"002\", \"TipoFactor\": \"Tasa\", \"TasaOCuota\": \"0.160000\", \"Importe\": \"16.00\" } ] } } ], \"Impuestos\": { \"TotalImpuestosTrasladados\": \"16.00\", \"Traslados\": [ { \"Base\": \"100.00\", \"Impuesto\": \"002\", \"TipoFactor\": \"Tasa\", \"TasaOCuota\": \"0.160000\", \"Importe\": \"16.00\" } ] } } } class TimbradoJsonService: def __init__(self, wsdl_url: str): self.wsdl_url = wsdl_url self.async_client = AsyncClient(self.wsdl_url) async def timbrar_json_async(self, api_key: str, json_layout: dict, key_pem_path: str, cer_pem_path: str) -\u003e RespuestaTimbrado: try: # 1. Convertir dict a JSON string y luego a Base64 json_str = json.dumps(json_layout) json_b64 = base64.b64encode(json_str.encode('utf-8')).decode('utf-8') # 2. Leer archivos PEM with open(key_pem_path, 'r') as f: key_pem = f.read() with open(cer_pem_path, 'r') as f: cer_pem = f.read() # 3. Llamar al servicio # Asumiendo que la operación se llama 'timbrarJSON' response = await self.async_client.service.timbrarJSON( apikey=api_key, jsonB64=json_b64, keyPEM=key_pem, cerPEM=cer_pem ) return RespuestaTimbrado( code=response.code, message=response.message, data=response.data ) except Exception as e: logging.error(f\"Error al timbrar con JSON: {e}\") raise # Ejemplo de uso async def main(): service = TimbradoJsonService(\"https://dev.facturaloplus.com/ws/servicio.do?wsdl\") api_key = \"TU_API_KEY_AQUI\"; key_pem = \"ruta/a/tu/llave.key.pem\"; cer_pem = \"ruta/a/tu/certificado.cer.pem\"; layout = get_json_layout(); // Carga el layout dinámicamente resultado = await service.timbrar_json_async(api_key, layout, key_pem, cer_pem); if resultado.code == \"200\": print(\"¡Timbrado con JSON Exitoso!\"); print(resultado.data); else: print(f\"Error: {resultado.code} - {resultado.message}\"); if __name__ == \"__main__\": asyncio.run(main()); Herramienta SoapClient PHP tiene soporte nativo para SOAP a través de la extensión SOAP. Asegúrate de que la extensión php-soap esté habilitada en tu archivo php.ini.\nImplementación \u003c?php // ... (Definición de la clase RespuestaTimbrado) /** * Genera dinámicamente el layout del CFDI como un string JSON. * En una aplicación real, los valores se obtendrían de una base de datos * o se construiría un array asociativo y se convertiría con json_encode. */ function getJsonLayout(): string { return \u003c\u003c\u003cJSON { \"Comprobante\": { \"Version\": \"4.0\", \"Serie\": \"F\", \"Folio\": \"123\", \"Fecha\": \"2025-07-04T12:00:00\", \"FormaPago\": \"01\", \"SubTotal\": \"100.00\", \"Moneda\": \"MXN\", \"Total\": \"116.00\", \"TipoDeComprobante\": \"I\", \"Exportacion\": \"01\", \"MetodoPago\": \"PUE\", \"LugarExpedicion\": \"64000\", \"Emisor\": { \"Rfc\": \"ABC010101XYZ\", \"Nombre\": \"Empresa Ejemplo SA de CV\", \"RegimenFiscal\": \"601\" }, \"Receptor\": { \"Rfc\": \"XAXX010101000\", \"Nombre\": \"Publico en General\", \"DomicilioFiscalReceptor\": \"64000\", \"RegimenFiscalReceptor\": \"616\", \"UsoCFDI\": \"G03\" }, \"Conceptos\": [ { \"ClaveProdServ\": \"01010101\", \"Cantidad\": \"1.0\", \"ClaveUnidad\": \"ACT\", \"Descripcion\": \"Producto de prueba\", \"ValorUnitario\": \"100.00\", \"Importe\": \"100.00\", \"ObjetoImp\": \"02\", \"Impuestos\": { \"Traslados\": [ { \"Base\": \"100.00\", \"Impuesto\": \"002\", \"TipoFactor\": \"Tasa\", \"TasaOCuota\": \"0.160000\", \"Importe\": \"16.00\" } ] } } ], \"Impuestos\": { \"TotalImpuestosTrasladados\": \"16.00\", \"Traslados\": [ { \"Base\": \"100.00\", \"Impuesto\": \"002\", \"TipoFactor\": \"Tasa\", \"TasaOCuota\": \"0.160000\", \"Importe\": \"16.00\" } ] } } } JSON; } class TimbradoJsonService { private string $wsdlUrl; public function __construct(string $wsdlUrl) { $this-\u003ewsdlUrl = $wsdlUrl; } public function timbrarJson(string $apiKey, string $jsonLayout, string $keyPemPath, string $cerPemPath): RespuestaTimbrado { $respuesta = new RespuestaTimbrado(); try { // 1. Codificar JSON a Base64 $jsonB64 = base64_encode($jsonLayout); // 2. Leer archivos PEM $keyPem = file_get_contents($keyPemPath); $cerPem = file_get_contents($cerPemPath); if ($keyPem === false || $cerPem === false) { throw new Exception(\"No se pudieron leer los archivos .pem\"); } // 3. Llamar al servicio $soapClient = new SoapClient($this-\u003ewsdlUrl, ['trace' =\u003e 1, 'exceptions' =\u003e true]); $params = [ 'apikey' =\u003e $apiKey, 'jsonB64' =\u003e $jsonB64, 'keyPEM' =\u003e $keyPem, 'cerPEM' =\u003e $cerPem ]; // Asumiendo que la operación se llama 'timbrarJSON' $response = $soapClient-\u003etimbrarJSON($params); $respuesta-\u003ecode = $response-\u003ereturn-\u003ecode ?? null; $respuesta-\u003emessage = $response-\u003ereturn-\u003emessage ?? null; $respuesta-\u003edata = $response-\u003ereturn-\u003edata ?? null; } catch (Exception $e) { $respuesta-\u003ecode = \"CLIENT_ERROR\"; $respuesta-\u003emessage = $e-\u003egetMessage(); } return $respuesta; } } // Ejemplo de uso $service = new TimbradoJsonService(\"https://dev.facturaloplus.com/ws/servicio.do?wsdl\"); $apiKey = \"TU_API_KEY_AQUI\"; $keyPem = \"ruta/a/tu/llave.key.pem\"; $cerPem = \"ruta/a/tu/certificado.cer.pem\"; $jsonLayout = getJsonLayout(); // Carga el layout dinámicamente $resultado = $service-\u003etimbrarJson($apiKey, $jsonLayout, $keyPem, $cerPem); header('Content-Type: text/plain'); if ($resultado-\u003ecode === '200') { echo \"¡Timbrado con JSON Exitoso!\\n\"; echo $resultado-\u003edata; } else { echo \"Error: {$resultado-\u003ecode} - {$resultado-\u003emessage}\\n\"; } ?\u003e Respuesta (Response) La estructura de la respuesta SOAP es la misma que la de la operación timbrar. El contenido de la etiqueta data será el XML del CFDI timbrado.\n\u003c?xml version=\"1.0\" encoding=\"UTF-8\"?\u003e \u003cSOAP-ENV:Envelope ...\u003e \u003cSOAP-ENV:Body\u003e \u003cns1:timbrarJSONResponse xmlns:ns1=\"urn:ws_api\"\u003e \u003creturn xsi:type=\"tns:RespuestaTimbrado\"\u003e \u003ccode xsi:type=\"xsd:string\"\u003eCÓDIGO\u003c/code\u003e \u003cmessage xsi:type=\"xsd:string\"\u003eMENSAJE\u003c/message\u003e \u003cdata xsi:type=\"xsd:string\"\u003e\u003c![CDATA[CFDI TIMBRADO]]\u003e\u003c/data\u003e \u003c/return\u003e \u003c/ns1:timbrarJSONResponse\u003e \u003c/SOAP-ENV:Body\u003e \u003c/SOAP-ENV:Envelope\u003e Códigos de respuesta Los códigos de respuesta para el timbrado de CFDI son importantes para entender el resultado de la solicitud. A continuación se detallan los códigos más comunes que puedes recibir al realizar una solicitud de timbrado a través de la API.\rCódigo\rDescripción\r200\rSolicitud procesada con éxito\r300\rAPI KEY Inválida o inexistente\r301\rXML mal formado\r302\rEl sello del emisor no es válido\r303\rEl RFC del CSD del emisor no corresponde al RFC del Emisor\r304\rCSD del Emisor ha sido revobado\r305\rLa fecha de emisión no está dentro de la vigencia del CSD del Emisor\r306\rLa llave utilizada para sellar debe ser un CSD\r307\rEl CFDI contiene un timbre previo\r308\rEl CSD del emisor no ha sido firmado por uno de los Certificados de autoridad del SAT\r401\rEl rango de la fecha de generación no debe de ser mayor a 72 horas para la emisión del timbre\r402\rRFC del emisor no se encuentra en el régimen de contribuyentes (Lista de validación de régimen) LCO","timbrarjson#timbrarJSON":""},"title":"timbrarJSON"},"/facturotas.docs/api/timbrado/timbrarjson2/":{"data":{"#":"timbrarJSON2Esta operación extiende la funcionalidad de timbrarJSON, permitiendo no solo generar y timbrar un CFDI a partir de un layout JSON, sino también obtener una representación en formato PDF del comprobante utilizando una plantilla predefinida.\nDescripción de la Operación Esta operación toma un layout JSON, lo convierte en un CFDI (versión 3.3 o 4.0), lo sella con los certificados proporcionados y lo timbra. Como resultado, devuelve una estructura JSON que contiene tanto el XML del CFDI timbrado como el contenido del PDF generado en formato Base64.\nParámetros de Entrada (Input) Parámetro Tipo de Dato Descripción apikey string Credencial de acceso al servicio (Solicita aquí). jsonB64 string Cadena en formato Base64 que contiene el layout JSON con la información del CFDI a generar. Conversor Base 64 keyPEM string Contenido del archivo de la llave privada (.key) en formato PEM. cerPEM string Contenido del archivo del certificado de llave pública (.cer) en formato PEM. plantilla string Identificador numérico de la plantilla a utilizar para la generación del PDF. Parámetros de Salida (Output) - RespuestaTimbrado Atributo Tipo de Dato Descripción code string Código de respuesta de la operación. message string Mensaje detallado de la respuesta. data string JSON string que contiene el XML del CFDI timbrado y el contenido del PDF en Base64. Debe ser decodificado para acceder a sus valores. Estructura del JSON de Entrada El JSON enviado en el parámetro jsonB64 debe seguir la siguiente estructura. Los valores vacíos deben enviarse como \"\". Conversor Base 64\n{ \"Comprobante\": { \"Version\": \"4.0\", \"Serie\": \"\", \"Folio\": \"\", \"Fecha\": \"2025-07-04T12:00:00\", \"FormaPago\": \"01\", \"NoCertificado\": \"\", \"CondicionesDePago\": \"\", \"SubTotal\": \"100.00\", \"Descuento\": \"0.00\", \"Moneda\": \"MXN\", \"TipoCambio\": \"1\", \"Total\": \"116.00\", \"TipoDeComprobante\": \"I\", \"Exportacion\": \"01\", \"MetodoPago\": \"PUE\", \"LugarExpedicion\": \"64000\", \"Confirmacion\": \"\", \"Emisor\": { \"Rfc\": \"ABC010101XYZ\", \"Nombre\": \"Empresa Ejemplo SA de CV\", \"RegimenFiscal\": \"601\" }, \"Receptor\": { \"Rfc\": \"XAXX010101000\", \"Nombre\": \"Publico en General\", \"DomicilioFiscalReceptor\": \"64000\", \"RegimenFiscalReceptor\": \"616\", \"UsoCFDI\": \"G03\" }, \"Conceptos\": [ { \"ClaveProdServ\": \"01010101\", \"Cantidad\": \"1.0\", \"ClaveUnidad\": \"ACT\", \"Descripcion\": \"Producto de prueba\", \"ValorUnitario\": \"100.00\", \"Importe\": \"100.00\", \"ObjetoImp\": \"02\", \"Impuestos\": { \"Traslados\": [ { \"Base\": \"100.00\", \"Impuesto\": \"002\", \"TipoFactor\": \"Tasa\", \"TasaOCuota\": \"0.160000\", \"Importe\": \"16.00\" } ] } } ], \"Impuestos\": { \"TotalImpuestosTrasladados\": \"16.00\", \"Traslados\": [ { \"Base\": \"100.00\", \"Impuesto\": \"002\", \"TipoFactor\": \"Tasa\", \"TasaOCuota\": \"0.160000\", \"Importe\": \"16.00\" } ] } } } Ejemplo de Código C#JavaPythonPHP Herramienta svcutil Descarga e instala la herramienta svcutil\nEjecuta el comando siguiente (DESARROLLO)\nsvcutil.exe https://dev.facturaloplus.com/ws/servicio.do?wsdl /out:ServicioTimbradoClient.cs /config:app.config Esto genera dos archivos: ServicioTimbradoClient.cs y la configuración en app.config\nImplementación // Se requiere la librería System.Text.Json using System.Text.Json; /// \u003csummary\u003e /// Genera dinámicamente el layout del CFDI en formato JSON. /// En una aplicación real, los valores se obtendrían de una base de datos o de la entrada del usuario. /// \u003c/summary\u003e /// \u003creturns\u003eUn string con el JSON del CFDI.\u003c/returns\u003e private static string GetJsonLayout() { // Usar un objeto anónimo para construir la estructura y luego serializarla. var cfdiLayout = new { Comprobante = new { Version = \"4.0\", Serie = \"F\", Folio = \"123\", Fecha = \"2025-07-04T12:00:00\", FormaPago = \"01\", SubTotal = \"100.00\", Moneda = \"MXN\", Total = \"116.00\", TipoDeComprobante = \"I\", Exportacion = \"01\", MetodoPago = \"PUE\", LugarExpedicion = \"64000\", Emisor = new { Rfc = \"ABC010101XYZ\", Nombre = \"Empresa Ejemplo SA de CV\", RegimenFiscal = \"601\" }, Receptor = new { Rfc = \"XAXX010101000\", Nombre = \"Publico en General\", DomicilioFiscalReceptor = \"64000\", RegimenFiscalReceptor = \"616\", UsoCFDI = \"G03\" }, Conceptos = new[] { new { ClaveProdServ = \"01010101\", Cantidad = \"1.0\", ClaveUnidad = \"ACT\", Descripcion = \"Producto de prueba\", ValorUnitario = \"100.00\", Importe = \"100.00\", ObjetoImp = \"02\", Impuestos = new { Traslados = new[] { new { Base = \"100.00\", Impuesto = \"002\", TipoFactor = \"Tasa\", TasaOCuota = \"0.160000\", Importe = \"16.00\" } } } } }, Impuestos = new { TotalImpuestosTrasladados = \"16.00\", Traslados = new[] { new { Base = \"100.00\", Impuesto = \"002\", TipoFactor = \"Tasa\", TasaOCuota = \"0.160000\", Importe = \"16.00\" } } } } }; return JsonSerializer.Serialize(cfdiLayout); } // Clase para deserializar la respuesta en el campo 'data' public class RespuestaData { public string Xml { get; set; } public string Pdf { get; set; } } public async Task\u003cRespuestaTimbrado\u003e TimbrarJson2Async(string apiKey, string jsonLayout, string keyPem, string cerPem, string plantilla) { var jsonB64 = Convert.ToBase64String(Encoding.UTF8.GetBytes(jsonLayout)); using var client = new ServicioTimbradoWSPortTypeClient(\"ServicioTimbradoWSPort\"); // Asumiendo que la operación se llama 'timbrarJSON2' var response = await client.timbrarJSON2Async(apiKey, jsonB64, keyPem, cerPem, plantilla); return new RespuestaTimbrado { Code = response.code, Message = response.message, Data = response.data }; } // Ejemplo de uso public async Task EjemploUsoTimbrarJson2Async() { string apiKey = \"TU_API_KEY_AQUI\"; string jsonLayout = GetJsonLayout(); // Generación dinámica string keyPem = File.ReadAllText(\"ruta/a/llave.key.pem\"); string cerPem = File.ReadAllText(\"ruta/a/certificado.cer.pem\"); string plantilla = \"1\"; // ID de la plantilla a usar var resultado = await TimbrarJson2Async(apiKey, jsonLayout, keyPem, cerPem, plantilla); if (resultado?.Code == \"200\" \u0026\u0026 !string.IsNullOrEmpty(resultado.Data)) { Console.WriteLine(\"¡Timbrado con JSON y PDF Exitoso!\"); // Deserializar el JSON de la respuesta var respuestaData = JsonSerializer.Deserialize\u003cRespuestaData\u003e(resultado.Data); Console.WriteLine(\"--- XML Timbrado ---\"); Console.WriteLine(respuestaData.Xml); // Guardar el PDF var pdfBytes = Convert.FromBase64String(respuestaData.Pdf); File.WriteAllBytes(\"comprobante.pdf\", pdfBytes); Console.WriteLine(\"\\nPDF guardado como comprobante.pdf\"); } else { Console.WriteLine($\"Error: {resultado?.Code} - {resultado?.Message}\"); } } Herramienta wsimport Java incluye la herramienta wsimport en el JDK para generar las clases cliente a partir de un WSDL.\nEjecuta el siguiente comando en tu terminal para el ambiente de DESARROLLO:\nwsimport -keep -p com.facturaloplus.cliente https://dev.facturaloplus.com/ws/servicio.do?wsdl -keep: Conserva los archivos fuente .java generados.\n-p: Especifica el paquete (package) donde se guardarán las clases.\nImplementación // Se recomienda usar una librería como Gson o Jackson para parsear el JSON de respuesta. // import com.google.gson.Gson; /** * Genera dinámicamente el layout del CFDI en formato JSON. */ public static String getJsonLayout() { // Usamos un Text Block de Java 15+ para legibilidad. return \"\"\" { \"Comprobante\": { \"Version\": \"4.0\", \"Serie\": \"F\", \"Folio\": \"123\", \"Fecha\": \"2025-07-04T12:00:00\", \"FormaPago\": \"01\", \"SubTotal\": \"100.00\", \"Moneda\": \"MXN\", \"Total\": \"116.00\", \"TipoDeComprobante\": \"I\", \"Exportacion\": \"01\", \"MetodoPago\": \"PUE\", \"LugarExpedicion\": \"64000\", \"Emisor\": { \"Rfc\": \"ABC010101XYZ\", \"Nombre\": \"Empresa Ejemplo SA de CV\", \"RegimenFiscal\": \"601\" }, \"Receptor\": { \"Rfc\": \"XAXX010101000\", \"Nombre\": \"Publico en General\", \"DomicilioFiscalReceptor\": \"64000\", \"RegimenFiscalReceptor\": \"616\", \"UsoCFDI\": \"G03\" }, \"Conceptos\": [ { \"ClaveProdServ\": \"01010101\", \"Cantidad\": \"1.0\", \"ClaveUnidad\": \"ACT\", \"Descripcion\": \"Producto de prueba\", \"ValorUnitario\": \"100.00\", \"Importe\": \"100.00\", \"ObjetoImp\": \"02\", \"Impuestos\": { \"Traslados\": [ { \"Base\": \"100.00\", \"Impuesto\": \"002\", \"TipoFactor\": \"Tasa\", \"TasaOCuota\": \"0.160000\", \"Importe\": \"16.00\" } ] } } ], \"Impuestos\": { \"TotalImpuestosTrasladados\": \"16.00\", \"Traslados\": [ { \"Base\": \"100.00\", \"Impuesto\": \"002\", \"TipoFactor\": \"Tasa\", \"TasaOCuota\": \"0.160000\", \"Importe\": \"16.00\" } ] } } } \"\"\"; } // Clase para mapear el JSON en el campo 'data' class RespuestaData { String xml; String pdf; } public CompletableFuture\u003cRespuestaTimbrado\u003e timbrarJson2Async(String apiKey, String jsonLayout, String keyPem, String cerPem, String plantilla) { return CompletableFuture.supplyAsync(() -\u003e { try { String jsonB64 = Base64.getEncoder().encodeToString(jsonLayout.getBytes(StandardCharsets.UTF_8)); ServicioTimbradoWSPortType port = new ServicioTimbradoWS().getServicioTimbradoWSPort(); // Asumiendo que la operación se llama 'timbrarJSON2' Respuesta response = port.timbrarJSON2(apiKey, jsonB64, keyPem, cerPem, plantilla); RespuestaTimbrado resultado = new RespuestaTimbrado(); resultado.setCode(response.getCode()); resultado.setMessage(response.getMessage()); resultado.setData(response.getData()); return resultado; } catch (Exception e) { throw new RuntimeException(\"Error en timbrarJSON2\", e); } }, executor); } // Ejemplo de uso public static void main(String[] args) { // ... (inicialización de service, apiKey, etc.) String jsonLayout = getJsonLayout(); // Generación dinámica String plantilla = \"1\"; service.timbrarJson2Async(apiKey, jsonLayout, keyPem, cerPem, plantilla).whenComplete((resultado, ex) -\u003e { if (ex == null \u0026\u0026 \"200\".equals(resultado.getCode())) { System.out.println(\"¡Timbrado con JSON y PDF Exitoso!\"); // Parsear el JSON de respuesta // Gson gson = new Gson(); // RespuestaData data = gson.fromJson(resultado.getData(), RespuestaData.class); // System.out.println(\"XML: \" + data.xml); // byte[] pdfBytes = Base64.getDecoder().decode(data.pdf); // Files.write(Paths.get(\"comprobante.pdf\"), pdfBytes); System.out.println(\"PDF guardado correctamente.\"); } else { /* ... manejo de error ... */ } service.shutdown(); }).join(); } Herramienta Zeep Para interactuar con servicios SOAP en Python, la librería zeep es una excelente opción. Proporciona una interfaz limpia y moderna.\nInstala la librería usando pip:\npip install zeep Implementación # ... (Definición de RespuestaTimbrado y configuración de logging) def get_json_layout() -\u003e dict: \"\"\" Genera dinámicamente el layout del CFDI como un diccionario de Python. En una aplicación real, los valores se obtendrían de una base de datos o de la entrada del usuario. \"\"\" return { \"Comprobante\": { \"Version\": \"4.0\", \"Serie\": \"F\", \"Folio\": \"123\", \"Fecha\": \"2025-07-04T12:00:00\", \"FormaPago\": \"01\", \"SubTotal\": \"100.00\", \"Moneda\": \"MXN\", \"Total\": \"116.00\", \"TipoDeComprobante\": \"I\", \"Exportacion\": \"01\", \"MetodoPago\": \"PUE\", \"LugarExpedicion\": \"64000\", \"Emisor\": { \"Rfc\": \"ABC010101XYZ\", \"Nombre\": \"Empresa Ejemplo SA de CV\", \"RegimenFiscal\": \"601\" }, \"Receptor\": { \"Rfc\": \"XAXX010101000\", \"Nombre\": \"Publico en General\", \"DomicilioFiscalReceptor\": \"64000\", \"RegimenFiscalReceptor\": \"616\", \"UsoCFDI\": \"G03\" }, \"Conceptos\": [ { \"ClaveProdServ\": \"01010101\", \"Cantidad\": \"1.0\", \"ClaveUnidad\": \"ACT\", \"Descripcion\": \"Producto de prueba\", \"ValorUnitario\": \"100.00\", \"Importe\": \"100.00\", \"ObjetoImp\": \"02\", \"Impuestos\": { \"Traslados\": [ { \"Base\": \"100.00\", \"Impuesto\": \"002\", \"TipoFactor\": \"Tasa\", \"TasaOCuota\": \"0.160000\", \"Importe\": \"16.00\" } ] } } ], \"Impuestos\": { \"TotalImpuestosTrasladados\": \"16.00\", \"Traslados\": [ { \"Base\": \"100.00\", \"Impuesto\": \"002\", \"TipoFactor\": \"Tasa\", \"TasaOCuota\": \"0.160000\", \"Importe\": \"16.00\" } ] } } } async def timbrar_json2_async(self, api_key: str, json_layout: dict, key_pem: str, cer_pem: str, plantilla: str) -\u003e RespuestaTimbrado: json_b64 = base64.b64encode(json.dumps(json_layout).encode('utf-8')).decode('utf-8') # Asumiendo que la operación se llama 'timbrarJSON2' response = await self.async_client.service.timbrarJSON2( apikey=api_key, jsonB64=json_b64, keyPEM=key_pem, cerPEM=cer_pem, plantilla=plantilla ) return RespuestaTimbrado(code=response.code, message=response.message, data=response.data) # Ejemplo de uso async def main(): # ... (inicialización de service, apiKey, etc.) layout = get_json_layout() // Generación dinámica plantilla = \"1\"; resultado = await service.timbrar_json2_async(api_key, layout, key_pem, cer_pem, plantilla) if resultado.code == \"200\" and resultado.data: print(\"¡Timbrado con JSON y PDF Exitoso!\") # Decodificar el JSON de la respuesta respuesta_data = json.loads(resultado.data) xml_timbrado = respuesta_data.get('xml') pdf_b64 = respuesta_data.get('pdf') print(\"--- XML Timbrado ---\") print(xml_timbrado) # Guardar el PDF with open(\"comprobante.pdf\", \"wb\") as f: f.write(base64.b64decode(pdf_b64)) print(\"\\nPDF guardado como comprobante.pdf\") else: print(f\"Error: {resultado.code} - {resultado.message}\") Herramienta SoapClient PHP tiene soporte nativo para SOAP a través de la extensión SOAP. Asegúrate de que la extensión php-soap esté habilitada en tu archivo php.ini.\nImplementación \u003c?php /** * Genera dinámicamente el layout del CFDI como un string JSON. * En una aplicación real, los valores se obtendrían de una base de datos * o se construiría un array asociativo y se convertiría con json_encode. */ function getJsonLayout(): string { return \u003c\u003c\u003cJSON { \"Comprobante\": { \"Version\": \"4.0\", \"Serie\": \"F\", \"Folio\": \"123\", \"Fecha\": \"2025-07-04T12:00:00\", \"FormaPago\": \"01\", \"SubTotal\": \"100.00\", \"Moneda\": \"MXN\", \"Total\": \"116.00\", \"TipoDeComprobante\": \"I\", \"Exportacion\": \"01\", \"MetodoPago\": \"PUE\", \"LugarExpedicion\": \"64000\", \"Emisor\": { \"Rfc\": \"ABC010101XYZ\", \"Nombre\": \"Empresa Ejemplo SA de CV\", \"RegimenFiscal\": \"601\" }, \"Receptor\": { \"Rfc\": \"XAXX010101000\", \"Nombre\": \"Publico en General\", \"DomicilioFiscalReceptor\": \"64000\", \"RegimenFiscalReceptor\": \"616\", \"UsoCFDI\": \"G03\" }, \"Conceptos\": [ { \"ClaveProdServ\": \"01010101\", \"Cantidad\": \"1.0\", \"ClaveUnidad\": \"ACT\", \"Descripcion\": \"Producto de prueba\", \"ValorUnitario\": \"100.00\", \"Importe\": \"100.00\", \"ObjetoImp\": \"02\", \"Impuestos\": { \"Traslados\": [ { \"Base\": \"100.00\", \"Impuesto\": \"002\", \"TipoFactor\": \"Tasa\", \"TasaOCuota\": \"0.160000\", \"Importe\": \"16.00\" } ] } } ], \"Impuestos\": { \"TotalImpuestosTrasladados\": \"16.00\", \"Traslados\": [ { \"Base\": \"100.00\", \"Impuesto\": \"002\", \"TipoFactor\": \"Tasa\", \"TasaOCuota\": \"0.160000\", \"Importe\": \"16.00\" } ] } } } JSON; } public function timbrarJson2(string $apiKey, string $jsonLayout, string $keyPem, string $cerPem, string $plantilla): RespuestaTimbrado { $respuesta = new RespuestaTimbrado(); try { $jsonB64 = base64_encode($jsonLayout); $soapClient = new SoapClient($this-\u003ewsdlUrl, ['trace' =\u003e 1, 'exceptions' =\u003e true]); $params = [ 'apikey' =\u003e $apiKey, 'jsonB64' =\u003e $jsonB64, 'keyPEM' =\u003e $keyPem, 'cerPEM' =\u003e $cerPem, 'plantilla' =\u003e $plantilla ]; // Asumiendo que la operación se llama 'timbrarJSON2' $response = $soapClient-\u003etimbrarJSON2($params); $respuesta-\u003ecode = $response-\u003ereturn-\u003ecode ?? null; $respuesta-\u003emessage = $response-\u003ereturn-\u003emessage ?? null; $respuesta-\u003edata = $response-\u003ereturn-\u003edata ?? null; } catch (Exception $e) { /* ... manejo de error ... */ } return $respuesta; } // Ejemplo de uso // ... (inicialización de service, apiKey, etc.) $jsonLayout = getJsonLayout(); // Generación dinámica $plantilla = \"1\"; $resultado = $service-\u003etimbrarJson2($apiKey, $jsonLayout, $keyPem, $cerPem, $plantilla); if ($resultado-\u003ecode === '200' \u0026\u0026 !empty($resultado-\u003edata)) { echo \"¡Timbrado con JSON y PDF Exitoso!\\n\"; // Decodificar el JSON de respuesta $data = json_decode($resultado-\u003edata, true); $xml = $data['xml']; $pdfB64 = $data['pdf']; echo \"--- XML Timbrado ---\\n\"; echo $xml; // Guardar el PDF file_put_contents(\"comprobante.pdf\", base64_decode($pdfB64)); echo \"\\nPDF guardado como comprobante.pdf\\n\"; } else { echo \"Error: {$resultado-\u003ecode} - {$resultado-\u003emessage}\\n\"; } ?\u003e Respuesta (Response) La estructura de la respuesta SOAP es similar a las anteriores, pero el contenido de la etiqueta data es un JSON que encapsula el XML y el PDF.\n\u003c?xml version=\"1.0\" encoding=\"UTF-8\"?\u003e \u003cSOAP-ENV:Envelope ...\u003e \u003cSOAP-ENV:Body\u003e \u003cns1:timbrarJSON2Response xmlns:ns1=\"urn:ws_api\"\u003e \u003creturn xsi:type=\"tns:RespuestaTimbrado\"\u003e \u003ccode xsi:type=\"xsd:string\"\u003e200\u003c/code\u003e \u003cmessage xsi:type=\"xsd:string\"\u003eOK\u003c/message\u003e \u003cdata xsi:type=\"xsd:string\"\u003e\u003c![CDATA[{ \"xml\": \"PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iVVRGLTgiPz48Y2ZkaT...\", \"pdf\": \"JVBERi0xLjQKJdPr6eEKMSAwIG9iago8PC9UeXBlL0NhdGFsb2cvT3V0bGlu...\" }]]\u003e\u003c/data\u003e \u003c/return\u003e \u003c/ns1:timbrarJSON2Response\u003e \u003c/SOAP-ENV:Body\u003e \u003c/SOAP-ENV:Envelope\u003e Códigos de respuesta Los códigos de respuesta para el timbrado de CFDI son importantes para entender el resultado de la solicitud. A continuación se detallan los códigos más comunes que puedes recibir al realizar una solicitud de timbrado a través de la API.\rCódigo\rDescripción\r200\rSolicitud procesada con éxito\r300\rAPI KEY Inválida o inexistente\r301\rXML mal formado\r302\rEl sello del emisor no es válido\r303\rEl RFC del CSD del emisor no corresponde al RFC del Emisor\r304\rCSD del Emisor ha sido revobado\r305\rLa fecha de emisión no está dentro de la vigencia del CSD del Emisor\r306\rLa llave utilizada para sellar debe ser un CSD\r307\rEl CFDI contiene un timbre previo\r308\rEl CSD del emisor no ha sido firmado por uno de los Certificados de autoridad del SAT\r401\rEl rango de la fecha de generación no debe de ser mayor a 72 horas para la emisión del timbre\r402\rRFC del emisor no se encuentra en el régimen de contribuyentes (Lista de validación de régimen) LCO","timbrarjson2#timbrarJSON2":""},"title":"timbrarJSON2"},"/facturotas.docs/guias/":{"data":{"guías#Guías":"GuíasThis section contains step-by-step guides to help you use the External API effectively."},"title":"_index"},"/facturotas.docs/herramientas/convertidorbase64/":{"data":{"":"Esta herramienta te permite codificar y decodificar texto fácilmente utilizando el formato Base64.\nTexto de Entrada Salida en Base64 Copiar al Portapapeles Limpiar "},"title":"Convertidor a Base64"}}